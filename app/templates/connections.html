<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connections - TitleCardMaker</title>

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/site.webmanifest">

  <!-- Formantic UI -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.js"></script>

  <!-- JS Files -->
  <script type="text/javascript" src="/templates/loadStaticContent.js"></script>
  <script type="text/javascript" src="/templates/loadCardTypes.js"></script>
  <!-- <script type="text/javascript" src="/templates/theme.js"></script> -->
  
  <!-- Global styles -->
  <link rel="stylesheet" type="text/css" href="/templates/style.css"/>
  <style>
    /* For library path inputs, align the library name/label to the right */
    .library.field,
    .library.field > input {
      text-align: right;
    }

    /* Blur private input fields when not selected or hovered */
    input.private:not(:hover,:focus) {
      color: transparent !important;
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
      
    }

    /* The first (enable) checkbox needs additional margin */
    .connection-form .checkbox:first-child {
      margin-bottom: 1em;
    }

    /* Ensure the Sonarr libraries info message is compact */
    #sonarr-libraries .compact.message {
      display: inline-block;
    }
  </style>

  <template id="sync-volume">
    <div class="two wide library field">
      <label>Library</label>
      <input type="text" placeholder="Library Name">
    </div>
    <div class="four wide field">
      <label>Path</label>
      <input type="text" placeholder="Library Path">
    </div>
  </template>

  <script>
    // Function to grab list of usernames from Emby
    async function getEmbyUsernames() {
      const usernames = await fetch('/api/available/usernames/emby').then(resp => resp.json());
      const select = document.getElementById('emby-username-select');
      const usernameElements = usernames.map(username => {
        let option = document.createElement('option');
        option.value = username;
        option.innerText = username;
        return option;
      });
      // Replace existing children
      select.replaceChildren(select.firstChild, ...usernameElements);
    }

    // Function to grab list of usernames from Jellyfin
    async function getJellyfinUsernames() {
      const usernames = await fetch('/api/available/usernames/jellyfin').then(resp => resp.json());
      const select = document.getElementById('jellyfin-username-select');
      const usernameElements = usernames.map(username => {
        let option = document.createElement('option');
        option.value = username;
        option.innerText = username;
        return option;
      });
      // Replace existing children
      select.replaceChildren(select.firstChild, ...usernameElements);
    }

    // Function to get the Sonarr library mappings
    async function getSonarrLibraries() {
      const libraries = await fetch('/api/settings/sonarr-libraries').then(resp => resp.json());
      libraries.forEach(({name, path}) => {
        // Append library inputs
        const libName = document.createElement('input');
        libName.type = 'text'; libName.placeholder = 'Library Name';
        libName.name = 'library_names'; libName.value = name;
        $('#sonarr-libraries-library-names').append(libName);
        // Append library paths
        const libPath = document.createElement('input');
        libPath.type = 'text'; libPath.placeholder = 'Library Path';
        libPath.name = 'library_paths'; libPath.value = path;
        $('#sonarr-libraries-library-paths').append(libPath);
      });
    }

    async function getLanguagePriorities() {
      const languages = await fetch('/api/settings/logo-language-priority').then(resp => resp.json());
      $('.dropdown[data-value="tmdb_logo_language_priority"]').dropdown({
        values: languages,
        clearable: true,
      });
    }

    async function initAll() {
      getEmbyUsernames();
      getJellyfinUsernames();
      getSonarrLibraries();
      getLanguagePriorities();
    }

    // Add new library path
    function addSonarrLibrary() {
      // Add library name input
      const nameInput = document.createElement('input');
      nameInput.type = 'text'; nameInput.placeholder = 'Library Name';
      nameInput.name = 'library_names';
      $('#sonarr-libraries-library-names').append(nameInput);
      // Add library path input
      const pathInput = document.createElement('input');
      pathInput.type = 'text'; pathInput.placeholder = 'Library Path';
      pathInput.name = 'library_paths';
      $('#sonarr-libraries-library-paths').append(pathInput);
    }
  </script>
  
</head>

<body onload="initAll();">
  <div class="pusher">
    <!-- Static header and sidebar loaded by external script -->
    <div id="page-header"></div>
    <div id="nav-menu"></div>

    <!-- Actual page content -->
    <div id="main-content" class="article">
      <!-- Page title -->
      <h1 class="ui header">Connections</h1>

      <!-- Emby Connections -->
      <h3 class="ui dividing header">Emby Media Server</h3>
      <div id="emby-connection" class="connection-form">
        <!-- Enable button -->
        {% if preferences.use_emby %}
        <div id="enable-emby" class="ui left aligned checked checkbox field">
          <input id="enable-emby-checkbox" type="checkbox" checked="">
        {% else %}
        <div id="enable-emby" class="ui left aligned checkbox field">
          <input id="enable-emby-checkbox" type="checkbox" >
        {% endif %}
          <label for="enable-emby-checkbox">Enable Emby</label>
        </div>

        <form id="emby-settings" class="ui fluid form">
          <div id="emby-url" class="ui disabled required eight wide field" title="Host URL to communicate with Emby">
            <label>URL</label>
            <input name="url" type="text" value="{{preferences.emby_url}}">
          </div>

          <div id="emby-api-key" class="ui disabled required eight wide field" title="API key to authenticate communication with Emby">
            <label>API Key</label>
            <input name="api_key" type="text" class="private" value="{{preferences.emby_api_key}}">
          </div>

          <div id="emby-username" class="ui disabled required field" title="Username of the Emby user to query watch statuses from">
            <label>Username</label>
            <select name="username" id="emby-username-select" class="ui compact search clearable dropdown">
              <option value=""></option>
              <!-- Options added via asynchronous requests -->
            </select>
          </div>

          <div id="emby-use-ssl" class="ui left aligned disabled checkbox field" title="Connect with HTTPS instead of HTTP">
            {% if preferences.emby_use_ssl %}
            <input name="use_ssl" id="emby-use-ssl-checkbox" type="checkbox" checked="">
            {% else %}
            <input name="use_ssl" id="emby-use-ssl-checkbox" type="checkbox">
            {% endif %}
            <label for="emby-use-ssl-checkbox">Use SSL</label>
          </div>

          <div id="emby-filesize-limit" class="ui disabled field" title="Maximum file size of assets to upload to Emby">
            <label>Filesize Limit</label>
            <div class="ui fields">
              <div class="two wide field">
                <input name="filesize_limit_number" type="number" min="0" value="{{preferences.emby_filesize_limit_number}}">
              </div>
              <div class="three wide field">
                <div class="ui selection dropdown">
                  <input name="filesize_limit_unit" type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text">{{preferences.emby_filesize_limit_unit}}</div>
                  <div class="scrollhint menu">
                    <div class="item">Bytes</div>
                    <div class="item">Kilobytes</div>
                    <div class="item">Megabytes</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class=field>
            <button id="submit-emby" class="ui primary animated button" type="submit">
              <div class="visible content">Save Changes</div>
              <div class="hidden content">
                <i class="right arrow icon"></i>
              </div>
            </button>
          </div>
        </form>
      </div>

      <!-- Jellyfin Connections -->
      <h3 class="ui dividing header">Jellyfin Media Server</h3>
      <div id="jellyfin-connection" class="connection-form">
        <!-- Enable button -->
        {% if preferences.use_jellyfin %}
        <div id="enable-jellyfin" class="ui left aligned checked checkbox field">
          <input id="enable-jellyfin-checkbox" type="checkbox" checked="">
        {% else %}
        <div id="enable-jellyfin" class="ui left aligned checkbox field">
          <input id="enable-jellyfin-checkbox" type="checkbox" >
        {% endif %}
          <label for="enable-jellyfin-checkbox">Enable Jellyfin</label>
        </div>

        <form id="jellyfin-settings" class="ui fluid form">
          <div id="jellyfin-url" class="ui disabled required eight wide field" title="Host URL to communicate with Jellyfin">
            <label>URL</label>
            <input name="url" type="text" value="{{preferences.jellyfin_url}}">
          </div>

          <div id="jellyfin-api-key" class="ui disabled required eight wide field" title="API key to authenticate communication with Jellyfin">
            <label>API Key</label>
            <input name="api_key" type="text" class="private" value="{{preferences.jellyfin_api_key}}">
          </div>

          <div id="jellyfin-username" class="ui disabled required field" title="Username of the Jellyfin user to query watch statuses from">
            <label>Username</label>
            <select name="username" id="jellyfin-username-select" class="ui compact search clearable dropdown">
              <option value=""></option>
              <!-- Options added via asynchronous requests -->
            </select>
          </div>

          <div id="jellyfin-use-ssl" class="ui left aligned disabled checkbox field" title="Connect with HTTPS instead of HTTP">
            {% if preferences.emby_use_ssl %}
            <input name="use_ssl" id="jellyfin-use-ssl-checkbox" type="checkbox" checked="">
            {% else %}
            <input name="use_ssl" id="jellyfin-use-ssl-checkbox" type="checkbox">
            {% endif %}
            <label for="emby-use-ssl-checkbox">Use SSL</label>
          </div>

          <div id="jellyfin-filesize-limit" class="ui disabled field" title="Maximum file size of assets to upload to Jellyfin">
            <label>Filesize Limit</label>
            <div class="ui fields">
              <div class="two wide field">
                <input name="filesize_limit_number" type="number" min="0" placeholder="{{preferences.jellyfin_filesize_limit_number}}" value="{{preferences.jellyfin_filesize_limit_number}}">
              </div>
              <div class="three wide field">
                <div class="ui selection dropdown">
                  <input name="filesize_limit_unit" type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text">{{preferences.jellyfin_filesize_limit_unit}}</div>
                  <div class="scrollhint menu">
                    <div class="item">Bytes</div>
                    <div class="item">Kilobytes</div>
                    <div class="item">Megabytes</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class=field>
            <button id="submit-jellyfin" class="ui primary animated button" type="submit">
              <div class="visible content">Save Changes</div>
              <div class="hidden content">
                <i class="right arrow icon"></i>
              </div>
            </button>
          </div>
        </form>
      </div>

      <!-- Plex Connections -->
      <h3 class="ui dividing header">Plex Media Server</h3>
      <div id="plex-connection" class="connection-form">
        <!-- Enable button -->
        <div id="enable-plex" class="ui left aligned checkbox field">
          {% if preferences.use_plex %}
          <input id="enable-plex-checkbox" type="checkbox" checked="">
          {% else %}
          <input id="enable-plex-checkbox" type="checkbox">
          {% endif %}
          <label>Enable Plex</label>
        </div>

        <form id="plex-settings" class="ui fluid form">
          <div id="plex-url" class="ui disabled required eight wide field" title="Host URL to communicate with Plex">
            <label>URL</label>
            <input name="url" type="text" value="{{preferences.plex_url}}">
          </div>
          
          <div id="plex-token" class="ui disabled eight wide field" title="Token to authenticate communication with Plex">
            <label>Token <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank"><i class="external alternate small icon"></i></a></label>
            <input name="token" type="text" class="private" value="{{preferences.plex_token}}">
          </div>

          {% if preferences.plex_use_ssl %}
          <div id="plex-use-ssl" class="ui left aligned disabled checked checkbox field" title="Connect with HTTPS instead of HTTP">
            <input name="use_ssl" id="plex-use-ssl-checkbox" type="checkbox" checked="">
          {% else %}
          <div id="plex-use-ssl" class="ui left aligned disabled checkbox field" title="Connect with HTTPS instead of HTTP">                  
            <input name="use_ssl" id="plex-use-ssl-checkbox" type="checkbox">
          {% endif %}
            <label>Use SSL</label>
          </div>
          <br>

          {% if preferences.plex_integrate_with_pmm %}
          <div id="plex-integrate-pmm" class="ui left aligned disabled checked checkbox field" title="Whether to reset PMM overlays when applying title cards">
            <input name="integrate_with_pmm" type="checkbox" checked="">
          {% else %}
          <div id="plex-integrate-pmm" class="ui left aligned disabled checkbox field" title="Whether to reset PMM overlays when applying title cards">
            <input name="integrate_with_pmm"type="checkbox">
          {% endif %}
            <label>Integrate with Plex Meta Manager</label>
          </div>

          <div id="plex-filesize-limit" class="ui disabled field" title="Maximum file size of assets to upload to Plex">
            <label>Filesize Limit</label>
            <div class="ui fields">
              <div class="two wide field">
                <input name="filesize_limit_number" id="plex-filesize-limit-input-number" type="number" min="1" value="{{preferences.plex_filesize_limit_number}}">
              </div>
              <div class="three wide field">
                <div class="ui selection dropdown">
                  <input name="filesize_limit_unit" type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text">{{preferences.plex_filesize_limit_unit}}</div>
                  <div class="scrollhint menu">
                    <div class="item">Bytes</div>
                    <div class="item">Kilobytes</div>
                    <div class="item">Megabytes</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Filesize warning -->
          {% if (preferences.plex_filesize_limit or 0) > 10485760 %}
          <div id="plex-filesize-warning" class="ui visible warning message">
          {% else %}
          <div id="plex-filesize-warning" class="ui warning message">
          {% endif %}
            <i class="exclamation triangle icon"></i>
            <b>Warning</b> Plex will reject images larger than <code>10 MB</code>
          </div>

          <div class=field>
            <button id="submit-plex" class="ui primary animated button" type="submit">
              <div class="visible content">Save Changes</div>
              <div class="hidden content">
                <i class="right arrow icon"></i>
              </div>
            </button>
          </div>
        </form>
      </div>

      <!-- Sonarr Connections -->
      <h3 class="ui dividing header">Sonarr</h3>
      <div id="sonarr-connection" class="connection-form">
        <!-- Enable button -->
        <div id="enable-sonarr" class="ui left aligned checkbox field">
          {% if preferences.use_sonarr %}
          <input id="enable-sonarr-checkbox" type="checkbox" name="enable_sonarr" checked="">
          {% else %}
          <input id="enable-sonarr-checkbox" type="checkbox" name="enable_sonarr">
          {% endif %}
          <label>Enable Sonarr</label>
        </div>

        <form id="sonarr-settings" class="ui fluid form">
          <div id="sonarr-url" class="ui disabled required eight wide field" title="Host URL to communicate with Sonarr">
            <label>URL</label>
            <input type="text" name="url" value="{{preferences.sonarr_url}}">
          </div>

          <div id="sonarr-api-key" class="ui disabled required eight wide field" title="API Key to authenticate communication with Sonarr">
            <label>API Key <a href="https://github.com/CollinHeist/TitleCardMaker/wiki/Sonarr-Attributes#sonarr-api-key" target="_blank"><i class="external alternate small icon"></i></a></label>
            <input name="api_key" type="text" class="private" value="{{preferences.sonarr_api_key}}">
          </div>

          {% if preferences.sonarr_use_ssl %}
          <div id="sonarr-use-ssl" class="ui left aligned disabled checked checkbox field" title="Connect with HTTPS instead of HTTP">
            <input name="use_ssl" id="sonarr-use-ssl-checkbox" type="checkbox" checked="">
          {% else %}
          <div id="sonarr-use-ssl" class="ui left aligned disabled checkbox field" title="Connect with HTTPS instead of HTTP">                  
            <input name="use_ssl" id="sonarr-use-ssl-checkbox" type="checkbox">
            {% endif %}
            <label>Use SSL</label>
          </div>
          <br>

          <div id="sonarr-libraries" class="ui disabled field">
            <label>Library Paths</label>
            <div class="ui compact floating visible info message">
              <i class="exclamation icon"></i>
              Only required if <a href="/sync">syncing</a> from Sonarr
            </div>
            <div class="fields">
              <div id="sonarr-libraries-library-names" class="two wide library field">
                <label>Library Name</label> 
                <!-- Added asynchronously -->
                <!-- <input type="text" placeholder="Library Name" name="library_names"> -->
              </div>
              <div id="sonarr-libraries-library-paths" class="four wide field">
                <label>Path</label>
                <!-- Added asynchronously -->
                <!-- <input type="text" placeholder="Library Path" name="library_paths"> -->
              </div>
            </div>
            <div class="circular ui icon mini button" onclick="addSonarrLibrary()">
              <i class="plus square outline icon"></i>
              Add Library
            </div>
          </div>

          <div class=field>
            <button id="submit-sonarr" class="ui primary animated button" type="submit">
              <div class="visible content">Save Changes</div>
              <div class="hidden content">
                <i class="right arrow icon"></i>
              </div>
            </button>
          </div>
        </form>
      </div>

      <!-- Tautulli Integration -->
      <h3 class="ui dividing header">Tautulli</h3>
      <button id="tautulli-agent-button" class="ui labeled icon blue button">
        <i class="bell icon"></i>
        Create Notification Agent
      </button>

      <!-- TMDb Connections -->
      <h3 class="ui dividing header">TheMovieDatabase</h3>
      <div id="tmdb-connection" class="connection-form">
        <!-- Enable button -->
        <div id="enable-tmdb" class="ui left aligned checkbox field">
          {% if preferences.use_tmdb %}
          <input id="enable-tmdb-checkbox" type="checkbox" name="enable_tmdb" checked="">
          {% else %}
          <input id="enable-tmdb-checkbox" type="checkbox" name="enable_tmdb">
          {% endif %}
          <label>Enable TMDb</label>
        </div>

        <form id="tmdb-settings" class="ui fluid form">
          <!-- Input fields -->
          <div id="tmdb-api-key" class="ui disabled required eight wide field" data-tooltip="API Key to authenticate communication with TMDb">
            <label>API Key <a href="https://developers.themoviedb.org/3/getting-started/introduction" target="_blank"><i class="external alternate small icon"></i></a></label>
            <input name="api_key"type="text" class="private" placeholder="{{preferences.tmdb_api_key}}" value="{{preferences.tmdb_api_key}}">
          </div>

          <div id="tmdb-minimum-resolution" class="two fields">
            <div class="two wide field" data-tooltip="Minimum required width of images to gather from TMDb">
              <label>Minimum Width</label>
              <input name="minimum_width" type="number" value="{{preferences.tmdb_minimum_width}}">
            </div>
            <div class="two wide field" data-tooltip="Minimum required height of images to gather from TMDb">
              <label>Minimum Height</label>
              <input name="minimum_height" type="number" value="{{preferences.tmdb_minimum_height}}">
            </div>
          </div>

          <div id="tmdb-skip-localized" class="ui left aligned checkbox field" data-tooltip="Whether to ignore images with assigned languages">
            {% if preferences.tmdb_skip_localized %}
            <input name="skip_localized" type="checkbox" checked="">
            {% else %}
            <input name="skip_localized" type="checkbox" >
            {% endif %}
            <label>Ignore Localized Images</label>
          </div>

          <br>
          <div id="tmdb-download-logos" class="ui left aligned checkbox field" data-tooltip="Whether to download logos automatically">
            {% if preferences.tmdb_download_logos %}
            <input name="download_logos" type="checkbox" checked="">
            {% else %}
            <input name="download_logos" type="checkbox">
            {% endif %}
            <label>Download Logos</label>
          </div>

          <div id="tmdb-logo-language-priority" class="field">
            <label>Logo Language Priority</label>
            <div data-value="tmdb_logo_language_priority" class="ui compact multiple selection dropdown">
              <input name="logo_language_priority" type="hidden">
              <i class="dropdown icon"></i>
              <div class="default text"></div>
              <div class="menu"><!-- Added asynchronousely --></div>
            </div>
          </div>

          <div class=field>
            <button id="submit-tmdb" class="ui primary animated button" type="submit">
              <div class="visible content">Save Changes</div>
              <div class="hidden content">
                <i class="right arrow icon"></i>
              </div>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="tautulli-agent-modal" class="ui small modal">
      <i class="close icon"></i>
      <div class="header">Tautulli Notification Agent</div>
      <div class="content">
        <div class="ui compact raised segment">
          <span><span class="ui blue text">TitleCardMaker</span> can create a Notification Agent on Tautulli to immediately update Title Cards for newly added or recently watched Episodes.</span>
        </div>
        <form id="tautulli-agent-form" class="ui form">
          <div class="ui field">
            <label>Tautulli URL</label>
            <input name="tautulli_url">
          </div>
          
          <div class="ui field">
            <label>Tautulli API Key</label>
            <input name="tautulli_api_key" type="password">
          </div>

          <div class="ui left aligned checkbox field">
            <input name="tautulli_use_ssl" type="checkbox" checked="">
            <label>Use SSL for Secure Connections</label>
          </div>

          <div class="ui field">
            <label>Notification Agent Name</label>
            <input name="tautulli_agent_name" value="Update TitleCardMaker" placeholder="Update TitleCardMaker">
          </div>
          <div class="ui info message"></div>
        </form>
      </div>
      <div class="actions">
        <button form="tautulli-agent-form" class="ui right labeled icon blue button">
          Create Agent
          <i class="checkmark icon"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Enable dropdowns, checkboxes
    $('.ui.dropdown').dropdown();

    // Attach Tautlli modal to button
    $('#tautulli-agent-modal')
      .modal({blurring: true})
      .modal('attach events', '#tautulli-agent-button', 'show')
      .modal('setting', 'transition', 'fade up')

    // Fields to enable/disable on button presses
    const toggleFields = [
      {title: 'Emby',     toggleAPI: '/api/connection/emby',     buttonId: '#enable-emby'},
      {title: 'Jellyfin', toggleAPI: '/api/connection/jellyfin', buttonId: '#enable-jellyfin'},
      {title: 'Plex',     toggleAPI: '/api/connection/plex',     buttonId: '#enable-plex'},
      {title: 'Sonarr',   toggleAPI: '/api/connection/sonarr',   buttonId: '#enable-sonarr'},
      {title: 'TMDb',     toggleAPI: '/api/connection/tmdb',     buttonId: '#enable-tmdb'},
    ];
    toggleFields.forEach(({title, buttonId, fields, toggleAPI}) => {
      $(buttonId).checkbox({
        onChecked: response => {
          $(`#${title.toLowerCase()}-settings .field`).toggleClass('disabled', false);
          $.ajax({
            type: 'PUT',
            url: `${toggleAPI}/enable`,
            success: response => {
              $.toast({
                class: 'blue info',
                title: `Enabled Connection to ${title}`,
              });
            }, error: response => {
              $.toast({
                class: 'error',
                title: `Error Enabling Connection to ${title}`,
                message: response.responseJSON.detail,
                displayTime: 0,
              });
            }, complete: () => {}
          });
        }, onUnchecked: () => {
          $(`#${title.toLowerCase()}-settings .field`).toggleClass('disabled', true);
          $.ajax({
            type: 'PUT',
            url: `${toggleAPI}/disable`,
            success: function(response) {
              $.toast({
                class: 'warning',
                title: `Disabled Connection to ${title}`,
              });
            }, error: function(response) {
              $.toast({
                class: 'error',
                title: `Error Disabling Connection to ${title}`,
                message: response.responseJSON.detail,
                displayTime: 0,
              });
            }, complete: function() {}
          });
        },
      })
    });

    // Initialize enabled/disabled states of form fields
    toggleFields.forEach(({title, buttonId}) => {
      $(`#${title.toLowerCase()}-settings .field`).toggleClass('disabled', !$(buttonId)[0].classList.contains('checked'));
    });
    
    // Show filesize warning in Plex if >10 MB
    $('#plex-filesize-limit').on('change', function(event) {
      let number = $('#plex-filesize-limit-input-number').val();
      let unit = $('#plex-filesize-limit-input-unit').val();
      let unitValues = {
        'B': 1, 'KB':  2**10, 'MB':  2**20, 'GB':  2**30, 'TB':  2**40
      };
      let current = unitValues[unit] * number,
          limit   = 10 * unitValues['MB'];
      $('#plex-filesize-warning').toggleClass('visible', current > limit);
    })

    // Add form validation
    $('#emby-settings').form({
      on: 'blur',
      inline: true,
      fields: {
        url: ['url', 'empty'],
        api_key: ['empty', 'regExp[/^[a-f0-9]+$/gi]'],
        filesize_limit_number: ['integer[0..]'],
      },
    });
    $('#jellyfin-settings').form({
      on: 'blur',
      inline: true,
      fields: {
        url: ['url', 'empty'],
        api_key: ['empty', 'regExp[/^[a-f0-9]+$/gi]'],
        filesize_limit_number: ['integer[0..]'],
      },
    });
    $('#plex-settings').form({
      on: 'blur',
      inline: true,
      fields: {
        url: ['url', 'empty'],
        // token: [],
        filesize_limit_number: ['integer[0..]'],
      },
    });
    $('#sonarr-settings').form({
      on: 'blur',
      inline: true,
      fields: {
        url: ['url', 'empty'],
        api_key: ['empty', 'regExp[/^[a-f0-9]+$/gi]'],
      },
    });
    $('#tmdb-settings').form({
      on: 'blur',
      inline: true,
      fields: {
        api_key: ['empty', 'regExp[/^[a-f0-9]+$/gi]'],
        minimum_width: ['integer[0..]'],
        minimum_height: ['integer[0..]'],
        logo_language_priority: ['empty', 'minLength[1]'],
      },
    });

    // Connection submit button handling
    const connections = [
      {connection: 'emby', title: 'Emby', formId: '#emby-settings', submitButtonId: '#submit-emby', successCallback: getEmbyUsernames},
      {connection: 'jellyfin', title: 'Jellyfin', formId: '#jellyfin-settings', submitButtonId: '#submit-jellyfin', successCallback: getJellyfinUsernames},
      {connection: 'plex', title: 'Plex', formId: '#plex-settings', submitButtonId: '#submit-plex'},
      {connection: 'sonarr', title: 'Sonarr', formId: '#sonarr-settings', submitButtonId: '#submit-sonarr'},
      {connection: 'tmdb', title: 'TMDb', formId: '#tmdb-settings', submitButtonId: '#submit-tmdb'},
    ]
    connections.forEach(({connection, title, formId, submitButtonId, successCallback}) => {
      $(formId).on('submit', (event) => {
        // Prevent default event form handler
        event.preventDefault();
        if (!$(formId).form('is valid')) { return; }

        // Merge multiple form inputs into list values
        let form = new FormData(event.target);
        let listData = {library_names: [], library_paths: []};
        for (const [key, value] of [...form.entries()]) {
          if (connection === 'sonarr') {
            if (key === 'library_names') { listData.library_names.push(value); }
            if (key === 'library_paths') { listData.library_paths.push(value); }
          }
          if (value === '') { form.delete(key); }
        }
        // Add checkbox status as true/false
        $.each($(formId).find('input[type=checkbox]'), (key, val) => {
          form.append($(val).attr('name'), $(val).is(':checked'))
        });

        // Submit API request
        $(submitButtonId).toggleClass('disabled loading', true);
        $.ajax({
          type: 'PATCH',
          url: `/api/connection/${connection}`,
          data: JSON.stringify({...Object.fromEntries(form.entries()), ...listData}),
          contentType: 'application/json',
          success: (response) => {
            if (successCallback !== undefined ) { successCallback(); }
            $.toast({
              class: 'blue info',
              title: `Updated Connection to ${title}`,
            });
            getEmbyUsernames();
            getJellyfinUsernames();
          }, error: (response) => {
            $.toast({
              class: 'error',
              title: `Invalid ${title} Connection`,
              // message: response.responseJSON.detail,
              displayTime: 0,
            });
          }, complete: () => {
            $(submitButtonId).toggleClass('disabled loading', false);
          }
        });
      });
    });

    // Tautulli agent form validation and submission
    $('#tautulli-agent-form').form({
      on: 'blur',
      inline: true,
      fields: {
        tautulli_url: ['url', 'empty'],
        tautulli_api_key: ['empty', 'regExp[/^[a-f0-9]+$/gi]'],
        tautulli_agent_name: {
          optional: true,
          value: ['minLength[1]']
        },
      },
    }).on('submit', event => {
      // Prevent default event form handler, validate form
      event.preventDefault();
      if (!$('#tautulli-agent-form').form('is valid')) { return; }

      // Create JSON from form
      const data = Object.fromEntries(new FormData(event.target));

      // Submit API request
      $('#tautulli-agent-modal button').toggleClass('loading', true);
      $.ajax({
        type: 'POST',
        url: '/api/connection/tautulli/integrate',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: response => {
          // Show toast, disable 
          $.toast({
            class: 'blue info',
            title: `Created "${data.tautulli_agent_name}" Notification Agent`,
            displayTime: 5000,
          });
          $('#tautulli-agent-modal button').toggleClass('disabled', true);
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Creating Notification Agent',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          $('#tautulli-agent-modal button').toggleClass('loading', false);
        }
      });
    });

  </script>
</body>

</html>