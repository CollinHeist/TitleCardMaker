<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{series.name}} - TitleCardMaker</title>

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/internal_assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/internal_assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/internal_assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/internal_assets/favicon/site.webmanifest">

  <!-- Formantic UI -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.js"></script>

  <!-- JS Files -->
  <script type="text/javascript" src="/templates/loadStaticContent.js"></script>
  <script type="text/javascript" src="/templates/loadCardTypes.js"></script>
  <script type="text/javascript" src="/templates/theme.js"></script>
  <script type="text/javascript" src="/templates/helper.js"></script>
  <script type="text/javascript" src="/templates/tablesort.js"></script>
  <script type="text/javascript" src="/templates/messages.js"></script>
  
  <!-- Global styles -->
  <link rel="stylesheet" type="text/css" href="/templates/style.css">
  <style>
    /* Override card width for poster */
    .ui.card {
      width: auto;
    }

    #poster {
      min-height: 200px;
    }

    /* Remove minimum width on progress bar */
    #card-progress .bar {
      min-width: 0;
    }

    /* Add field buttons appear transparent */
    .add-field.button {
      background: transparent;
    }

    /* Inine fields need to flex and align content in the middle of their div */
    #new-episode-form .inline.field {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    #new-episode-form .number.input {
      width: 85px;
    }
    #new-episode-form .text.input {
      width: 100%;
      overflow-wrap: break-word;
    }

    /* Add top padding above the delete button for each episode */
    .tab[data-tab="episode-data"] .negative.button {
      margin-top: 5px;
    }

    /* Fix width of new episode modal */
    #new-episode-modal {
      width: 500px !important;
    }
    /* Use right-aligned inline labels */
    #new-episode-form label {
      flex: 0 0 125px;
      display: flex;
      margin-right: 10px;
      justify-content: flex-end;
      text-align: right;
    }

    /* Position table header below page header drop shadow */
    .table thead {
      z-index: 3;
    }

    /* Fade any indetermine status icons */
    .table .question.icon {
      opacity: 30%;
    }

    /* Show the icon is clickable by changing the cursor on hover */
    .table .ui.icon:hover {
      cursor: pointer;
    }
    .table td.center.aligned input {
      text-align: center !important;
    }

    /* Set default width of input fields */
    .table .transparent.id.input input,
    .table .transparent.number.input input,
    .table .transparent.short.input input {
      width: 8ch;
    }
    /* IMDB ID inputs are slightly larger */
    .table .transparent.id.input input[name="imdb_id"] {
      width: 10ch;
    }

    #episode-data-table .ui.multiple.dropdown {
      padding: unset;
    }

    /* Limit card size to 33% */
    #files-list .card {
      max-width: calc(33% - 1em);
    }
    
    /* Show cursor on all file card icons, and images in tmdb modal */
    #files-list .card .icon,
    #browse-tmdb-modal .image.content .images a {
      cursor: pointer;
    }

    /* File search icon should color semantic blue on hover */
    #files-list .card i[data-action="search"]:hover {
      color: #2185d0;
    }

    /* Upload file icon should color semantic green on hover */
    #files-list .card i[data-action="upload"]:hover {
      color: #21ba45;
    }

    /* The TMDb logo should be 14px high */
    #files-list .card img {
      height: 14px;
      padding-right: 3px;
    }

    /* Add padding between images on TMDb image browser */
    #browse-tmdb-modal .image.content .images a {
      display: inline-block;
      margin: 0 .25rem 0.5rem;
    }
  </style>

  <!-- Templates -->
  <template id="episode-row">
    <tr class="center aligned"> 
      <td data-column="edit" class="selectable">
        <a><i class="ui blue save outline icon"></i></a>
      </td>
      <td data-column="season_number" class="center aligned collapsing">0</td>
      <td data-column="episode_number" class="center aligned collapsing">0</td>
      <td data-column="absolute_number" class="center aligned collapsing">
        <div class="ui transparent short input">
          <input name="absolute_number" type="text" placeholder="-">
        </div>
      </td>
      <td data-column="title" class="left aligned">
        <div class="ui transparent input">
          <input name="title" type="text" placeholder="">
        </div>
      </td>
      <td data-column="match_title" data-type="boolean" class="center aligned collapsing"><!-- Icon --></td>
      <td data-column="auto_split_title" data-type="boolean" class="center aligned collapsing"><!-- Icon --></td>
      <td data-column="templates" class="center aligned collapsing">
        <div data-value="template_ids" class="ui inline clearable scrolling multiple dropdown">
          <input name="template_ids" type="hidden">
          <i class="dropdown icon"></i>
          <div class="default text">Default</div>
          <div class="menu"><!-- Submenu --></div>
        </div>
      </td>
      <td data-column="font_id" class="center aligned collapsing">
        <div data-value="font_id" class="ui inline clearable dropdown">
          <input name="font_id" type="hidden">
          <i class="dropdown icon"></i>
          <div class="default text">Default</div>
          <div class="menu"><!-- Submenu --></div>
        </div>
      </td>
      <td data-column="card_type" class="center aligned collapsing">
        <div data-value="card_type" class="ui inline clearable scrolling search dropdown">
          <input name="card_type" type="hidden">
          <i class="dropdown icon"></i>
          <div class="default text">Default</div>
          <div class="menu"><!-- Submenu --></div>
        </div>
      </td>
      <td data-column="hide_season_text" data-type="boolean" class="center aligned collapsing"><!-- Icon --></td>
      <td data-column="season_text" class="center aligned collapsing">
        <div class="ui transparent short input">
          <input name="season_text" type="text" placeholder="Default">
        </div>
      </td>
      <td data-column="hide_episode_text" data-type="boolean" class="center aligned collapsing"><!-- Icon --></td>
      <td data-column="episode_text" class="center aligned collapsing">
        <div class="ui transparent short input">
          <input name="episode_text" type="text" placeholder="Default">
        </div>
      </td>
      <td data-column="unwatched_style" class="center aligned collapsing">
        <div data-value="unwatched_style" class="ui inline clearable dropdown">
          <input name="unwatched_style" type="hidden">
          <i class="dropdown icon"></i>
          <div class="default text">Default</div>
          <div class="menu"><!-- Submenu --></div>
        </div>
      </td>
      <td data-column="watched_style" class="center aligned collapsing">
        <div data-value="watched_style" class="ui inline clearable dropdown">
          <input name="watched_style" type="hidden">
          <i class="dropdown icon"></i>
          <div class="default text">Default</div>
          <div class="menu"><!-- Submenu --></div>
        </div>
      </td>
      <td data-column="font_color" class="center aligned collapsing">
        <div class="ui transparent short input">
          <input name="font_color" type="text" placeholder="Default">
        </div>
      </td>
      <td data-column="font_size" class="center aligned collapsing">
        <div class="ui transparent number input">
          <input name="font_size" value="{episode.font_size}" placeholder="Default">
        </div>
      </td>
      <td data-column="font_stroke_width" class="center aligned collapsing">
        <div class="ui transparent number input">
          <input name="font_stroke_width" placeholder="Default">
        </div>
      </td>
      <td data-column="font_interline_spacing" class="center aligned collapsing">
        <div class="ui transparent number input">
          <input name="font_interline_spacing" placeholder="Default">
        </div>
      </td>
      <td data-column="font_vertical_shift" class="center aligned collapsing">
        <div class="ui transparent number input">
          <input name="font_vertical_shift" placeholder="Default">
        </div>
      </td>
      <td data-column="extras" class="selectable">
        <a><i class="ui eye outline icon"></i></a>
      </td>
      <td data-column="source_file" class="center aligned collapsing">
        <div class="ui transparent short input">
          <input name="source_file" type="text" placeholder="Default">
        </div>
      </td>
      <td data-column="card_file" class="center aligned collapsing">
        <div class="ui transparent short input">
          <input name="card_file" type="text" placeholder="Default">
        </div>
      </td>
      <td data-column="watched" data-type="boolean" class="center aligned collapsing"><!-- Icon --></td>
      {% if preferences.use_emby and series.emby_library_name %}
      <td data-column="emby_id" class="center aligned collapsing">
        <div class="ui transparent id input">
          <input name="emby_id" type="text" placeholder="-">
        </div>
      </td>
      {% endif %}
      <td data-column="imdb_id" class="center aligned collapsing">
        <div class="ui transparent id input">
          <input name="imdb_id" type="text" placeholder="-">
        </div>
      </td>
      {% if preferences.use_jellyfin and series.jellyfin_library_name %}
      <td data-column="jellyfin_id" class="center aligned collapsing">
        <div class="ui transparent id input">
          <input name="jellyfin_id" type="text" placeholder="-">
        </div>
      </td>
      {% endif %}
      <td data-column="tmdb_id" class="center aligned collapsing">
        <div class="ui transparent id input">
          <input name="tmdb_id" type="text" placeholder="-">
        </div>
      </td>
      <td data-column="tvdb_id" class="center aligned collapsing">
        <div class="ui transparent id input">
          <input name="tvdb_id" type="text" placeholder="-">
        </div>
      </td>
      {% if series.year < 2017 %}
      <td data-column="tvrage_id" class="center aligned collapsing">
        <div class="ui transparent id input">
          <input name="tvrage_id" type="text" placeholder="-">
        </div>
      </td>
      {% endif %}
      <td data-column="delete" class="selectable">
        <a><i class="ui red trash alternate outline icon"></i></a>
      </td>
    </tr>
  </template>

  <template id="translation-template">
    <span class="ui text">
      Translate
      <div data-value="language_code" class="ui inline scrolling clearable dropdown">
        <input name="language_code" type="hidden">
        <div class="text">French</div>
        <i class="dropdown icon"></i>
        <div class="menu"><!-- Added asynchronously --></div>
      </div>
      titles into 
      <div data-value="data_key" class="ui inline user-additions search clearable dropdown">
        <input name="data_key" type="hidden">
        <div class="text"></div>
        <i class="dropdown icon"></i>
        <div class="menu"><!-- Added asynchronously --></div>
      </div>
    </span>
    <br>
  </template>

  <template id="blueprint-template">
    <div class="ui card">
      <div class="image">
        <img src="">
      </div>
      <div class="content">
        <div data-value="creator" class="header">{author}</div>
        <div class="meta">
          <span data-value="font-count"><b>{x}</b> Named Font</span>
          <span data-value="template-count"><b>{x}</b> Template</span>
          <span data-value="episode-count"><b>{x}</b> Episode Overrides</span>
        </div>
        <div data-value="description" class="description"><!-- <p>Description</p> --></div>
      </div>
      <div class="extra content">
        <a data-action="import-blueprint" class="left floated">
          <i class="cloud download alternate icon"></i>
          Import
        </a>
      </div>
    </div>
  </template>

  <template id="file-template">
    <div class="ui card">
      <div class="content">
        <i data-action="search" class="right floated search icon" title="Search for this image"></i>
        <i data-action="upload" class="right floated file import icon" title="Upload a new source image"></i>
        {% if preferences.use_tmdb %}
        <img data-action="browse-tmdb" class="right floated icon" src="/internal_assets/tmdb_primary_full_logo.svg" title="Browse TMDb source images"/>
        {% endif %}
        <div data-value="index" class="header">{descriptive name}</div>
        <div class="meta">
          <span data-value="path">{path}</span>
          <div data-value="missing" class="ui tiny red label">Missing</div>
          <div data-value="dimension" class="ui tiny uninvertible label">{dimensions}</div>
          <div data-value="filesize" class="ui tiny uninvertible label">{filesize}</div>
        </div>
      </div>
    </div>
  </template>

  <script>
    async function getStatistics() {
      const statistics = await fetch('/api/statistics/series/{{series.id}}').then(resp => resp.json());
      const cardStat = statistics[0],
            episodeStat = statistics[1];
      $('#card-count')[0].innerHTML = `<i class="image outline icon"></i><span class="ui text">${cardStat.value} Cards / ${episodeStat.value} Episodes</span>`;
      let cardVal = Math.min(cardStat.value, episodeStat.value);
      $('#card-progress')[0].dataset.total = episodeStat.value;
      $('#card-progress')[0].dataset.value = `${cardVal},${episodeStat.value-cardVal}`;
      $('#card-progress').progress();
    }

    async function getLibraries() {
      if (document.getElementById('emby-library') != null) {
        const embyLibraries = await fetch('/api/available/libraries/emby').then(resp => resp.json());
        $('#emby-library').dropdown({
          values: embyLibraries.map(name => {
            return {name: name, value: name, selected: name === '{{series.emby_library_name}}'};
          })
        });
      }

      if (document.getElementById('jellyfin-library') != null) {
        const jellyfinLibraries = await fetch('/api/available/libraries/jellyfin').then(resp => resp.json());
        $('#jellyfin-library').dropdown({
          values: jellyfinLibraries.map(name => {
            return {name: name, value: name, selected: name === '{{series.jellyfin_library_name}}'};
          })
        });
      }

      if (document.getElementById('plex-library') != null) {
        const plexLibraries = await fetch('/api/available/libraries/plex').then(resp => resp.json());
        $('#plex-library').dropdown({
          values: plexLibraries.map(name => {
            return {name: name, value: name, selected: name === '{{series.plex_library_name}}'};
          })
        });
      }
    }
  
    function getUpdateEpisodeObject(episodeId) {
      // Get all inputs for this episode
      const episodeInputs = $(`#episode-id${episodeId} input`);
      // Construct updateEpisode object
      let updateEpisode = {},
          template_ids = [];
      Object.entries(episodeInputs).forEach(([index, input]) => {
        if (input.name !== undefined) {
          // Handle Templates
          if (input.name === 'template_ids' && input.value !== '') {
            template_ids = input.value.split(','); 
          }
          // Handle percentage values
          else if (input.value != '' && ['font_size', 'font_kerning', 'font_stroke_width'].includes(input.name)) {
            updateEpisode[input.name] = input.value/100.0;
          } else {
            updateEpisode[input.name] = input.value;
          }
        }
      });
      // Append boolean state icons to object as none/true/false
      $(`#episode-id${episodeId} td[data-type="boolean"]`).each((index, value) => {
        const iconClassList = value.firstChild.classList;
        if (iconClassList.contains('question')) {
          updateEpisode[value.dataset['column']] = null;
        } else if (iconClassList.contains('check')) {
          updateEpisode[value.dataset['column']] = true;
        } else {
          updateEpisode[value.dataset['column']] = false;
        }
      });

      return {...updateEpisode, template_ids: template_ids};
    }

    function saveEpisodeConfig(episodeId) {
      // Submit API request
      const updateEpisodeObject = getUpdateEpisodeObject(episodeId);
      $.ajax({
        type: 'PATCH',
        url: `/api/episodes/${episodeId}`,
        contentType: 'application/json',
        data: JSON.stringify(updateEpisodeObject),
        success: response => {
          $.toast({ class: 'blue info', title: 'Updated Episode'});
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Updating Episode',
            message: response.message,
          })
        }
      });
    }

    function saveAllEpisodes() {
      // Get update objects
      const updateEpisodeObjects = editedEpisodeIds.map(episodeId => {
        return {
          episode_id: episodeId,
          update_episode: getUpdateEpisodeObject(episodeId),
        };
      });

      // Submit API request
      $.ajax({
        type: 'PATCH',
        url: '/api/episodes/batch',
        contentType: 'application/json',
        data: JSON.stringify(updateEpisodeObjects),
        success: response => {
          // Updated successfully, show toast and reset list
          $.toast({ class: 'blue info', title: `Updated ${updateEpisodeObjects.length} Episodes`});
          editedEpisodeIds = [];
        }, error: response => {
          $.toast({
            class: 'error',
            title: `Error Updating ${updateEpisodeObjects.length} Episodes`,
            message: response.message,
            displayTime: 0,
          })
        }
      });
    }

    async function initAll() {
      initalizeSeriesConfig();
      getStatistics();
      getLibraries();
      getEpisodeData();
      getFileData();
      initStyles();
      // Schedule recurring statistics query
      setInterval(getStatistics, 30000); // Refresh stats every 30s
    }

    // Functions that can be triggered by a button press

    async function toggleMonitorStatus() {
      $.ajax({
        type: 'POST',
        url: '/api/series/{{series.id}}/toggle-monitor',
        success: response => {
          // Show toast, toggle text and icon to show new status
          if (response.monitored) {
            $.toast({class: 'blue info', title: 'Started Monitoring Series'});
            $('#monitor-status span').toggleClass('red', false).toggleClass('green', true);
            $('#monitor-status span')[0].innerHTML = '<i class="ui eye outline green icon"></i>Monitored';
          } else {
            $.toast({class: 'blue info', title: 'Stopped Monitoring Series'});
            $('#monitor-status span').toggleClass('red', true).toggleClass('green', false);
            $('#monitor-status span')[0].innerHTML = '<i class="ui eye slash outline red icon"></i>Unmonitored';
          }
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Changing Status',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          refreshTheme();
        }
      });
    }

    function refreshEpisodeData() {
      $('#refresh').toggleClass('disabled', true);
      $('#refresh > i').toggleClass('loading', true);
      $.ajax({
        type: 'POST',
        url: '/api/episodes/{{series.id}}/refresh',
        success: response => {
          $.toast({class: 'blue info', title: `Refreshed Episode Data`});
          getEpisodeData();
          getFileData();
          getStatistics();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Refreshing Data',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          $('#refresh').toggleClass('disabled', false);
          $('#refresh > i').toggleClass('loading', false);
        }
      });
    }

    function addTranslations() {
      $('#add-translations > i').toggleClass('loading', true);
      $.ajax({
        type: 'POST',
        url: '/api/translate/series/{{series.id}}',
        success: response => {
          $.toast({class: 'blue info', title: `Adding Translations`});
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Adding Translations',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          $('#add-translations > i').toggleClass('loading', false);
        }
      });
    }

    function importBlueprint(cardId, blueprint) {
      // Turn on loading
      $(`#${cardId}`).toggleClass('slow double blue loading', true);
      // Submit API request to import blueprint
      $.ajax({
        type: 'PUT',
        url: '/api/blueprints/import/series/{{series.id}}',
        contentType: 'application/json',
        data: JSON.stringify(blueprint),
        success: response => {
          $.toast({class: 'blue info', title: 'Blueprint Imported'});
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Importing Blueprint',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          $(`#${cardId}`).toggleClass('slow double blue loading', false);
        }
      });
      // Get any URL's for Fonts to download
      let fontsToDownload = [];
      blueprint.fonts.forEach(font => {
        if (font.file_download_url) {
          fontsToDownload.push(font.file_download_url);
        }
      });
      // If any Fonts need downloaded, show toast
      if (fontsToDownload.length > 0) {
        $.toast({
          class: 'blue info',
          title: 'Font Files',
          message: 'This Blueprint specifies Named Fonts that require manually downloaded files.',
          displayTime: 0,
          classActions: 'basic left',
          actions: [
            {
              text: 'Open Pages',
              click: () => {
                fontsToDownload.forEach(url => window.open(url, '_blank'));
              }
            }, {
              icon: 'ban',
              class: 'icon red',
              click: () => {
                $.toast({
                  class: 'error',
                  message: 'Blueprint Fonts will not be correct if files are not downloaded',
                  displayTime: 10000,
                })
              }
            }
          ],
        });
      }
    }

    async function queryBlueprints() {
      // Get template
      const blueprintCards = document.getElementById('blueprint-cards');
      const blueprintTemplate = document.getElementById('blueprint-template');
      if (blueprintCards === null || blueprintTemplate === null) { return; }
      // Show loading message
      $('.tab[data-tab="blueprints"] .info.message').toggleClass('hidden', false);
      // Query for Blueprints
      const allBlueprints = await fetch(`/api/blueprints/query/series/{{series.id}}`).then(resp => resp.json());
      $('.tab[data-tab="blueprints"] .info.message').toggleClass('hidden', true);
      // Disable query button
      $('.tab[data-tab="blueprints"] .button[data-action="search"]').toggleClass('disabled', true);
      // No blueprints available, hide loading and show warning message
      if (allBlueprints === null || allBlueprints.length === 0) {
        $('.tab[data-tab="blueprints"] .warning.message').toggleClass('hidden', false);
        return;
      }
      // Blueprints available, create cards
      const blueprints = allBlueprints.map((blueprint, blueprintId) => {
        // Clone template
        const card = blueprintTemplate.content.cloneNode(true);
        // Fill out card
        card.querySelector('.card').id = `blueprint-id${blueprintId}`;
        card.querySelector('img').src = blueprint.preview;
        card.querySelector('[data-value="creator"]').innerText = blueprint.creator;
        if (blueprint.fonts.length === 0) {
          card.querySelector('[data-value="font-count"]').remove();
        } else {
          let text = `<b>${blueprint.fonts.length}</b> Named Font` + (blueprint.fonts.length > 1 ? 's' : '');
          card.querySelector('[data-value="font-count"]').innerHTML = text;
        }
        if (blueprint.templates.length === 0) {
          card.querySelector('[data-value="template-count"]').remove();
        } else {
          let text = `<b>${blueprint.templates.length}</b> Template` + (blueprint.templates.length > 1 ? 's' : '');
          card.querySelector('[data-value="template-count"]').innerHTML = text;
        }
        if (Object.keys(blueprint.episodes).length === 0) {
          card.querySelector('[data-value="episode-count"]').remove();
        } else {
          let text = `<b>${Object.keys(blueprint.episodes).length}</b> Episode Override` + (blueprint.episodes.length > 1 ? 's' : '');
          card.querySelector('[data-value="episode-count"]').innerHTML = text;
        }
        card.querySelector('[data-value="description"]').innerHTML = '<p>' + blueprint.description.join('</p><p>') + '</p>';
        // Assign import to button
        card.querySelector('a[data-action="import-blueprint"]').onclick = () => importBlueprint(`blueprint-id${blueprintId}`, blueprint);
        return card;
      });
      blueprintCards.replaceChildren(...blueprints);
    }

    async function exportBlueprint() {
      $.ajax({
        type: 'GET',
        url: '/api/blueprints/export/series/{{series.id}}/zip',
        xhrFields: {responseType: 'blob'},
        success: zipBlob => {
          // Download zip file
          downloadFileBlob('{{series.full_name}} Blueprint.zip', zipBlob);
          $.toast({
            class: 'warning',
            title: 'Font Files',
            message: 'Verify any applicable Font licenses allow the Fonts to be shared. If you are not sure, a link to where the Font can be obtained should be used instead.',
            displayTime: 15000,
          });
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Exporting Blueprint',
            message: response.responseJSON.detail,
          });
        }, complete: () => {},
      })
    }

    function selectTmdbImage(episodeId, url) {
      // Create psuedo form for this URL
      const form = new FormData();
      form.set('source_url', url);
      // Submit API request to upload this URL
      $.ajax({
        type: 'POST',
        url: `/api/sources/episode/${episodeId}/upload`,
        data: form,
        cache: false,
        contentType: false,
        processData: false,
        success: response => {
          $.toast({class: 'blue info', title: 'Updated source image'});
          getFileData();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error updating source image',
            message: response.responseJSON.detail,
          });
        }, complete: () => {},
      });
    }

    async function browseTmdbImages(episodeId, cardElementId) {
      // Get all source images for this Episode
      $(`#${cardElementId}`).toggleClass('loading', true);
      const images = await fetch(`/api/sources/episode/${episodeId}/browse`).then(resp => resp.json());
      $(`#${cardElementId}`).toggleClass('loading', false);
      // If null, no images were returned
      if (images === null) {
        $.toast({class: 'error', title: 'Unable to Query TMDb'});
        return;
      } else if (images.detail !== undefined) {
        $.toast({class: 'error', title: 'Unable to Query TMDb', message: images.detail});
        return;
      }

      // Images returned, add to browse modal
      const imageElements = images.map(({url, width, height}, index) => {
        const location = index % 2 ? 'right' : 'left';
        return `<a class="ui image" onclick="selectTmdbImage(${episodeId}, '${url}')"><div class="ui blue ${location} ribbon label">${width}x${height}</div><img src="${url}"/></a>`;
      });
      $('#browse-tmdb-modal .content .images')[0].innerHTML = imageElements.join('');
      $('#browse-tmdb-modal').modal('show');
    }

    async function getEpisodeSourceImage(episodeId, cardElementId) {
      $(`#${cardElementId}`).toggleClass('loading', true);
      $.ajax({
        type: 'POST',
        url: `/api/sources/episode/${episodeId}`,
        success: response => {
          if (response === null) {
            $.toast({class: 'warning', title: 'Unable to Download Image'});
          } else {
            $.toast({class: 'blue info', title: 'Downloaded Image'});
          }
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Download Source Image',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          $(`#${cardElementId}`).toggleClass('loading', false);
        }
      });
    }

    function getSourceImages() {
      $('#download-source-images > i').toggleClass('loading', true);
      $.toast({class: 'blue info', title: 'Starting to Download Source Images'});
      $.ajax({
        type: 'POST',
        url: '/api/sources/series/{{series.id}}',
        success: response => {
          getFileData();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Download Source Images',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {
          $('#download-source-images > i').toggleClass('loading', false);
        }
      });
    }

    function createTitleCards() {
      $.ajax({
        type: 'POST',
        url: '/api/cards/series/{{series.id}}',
        success: response => {
          getEpisodeData();
          getStatistics();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error creating Title Cards',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, 
      });
    }

    function loadCards(mediaServer, reload) {
      $.ajax({
        type: 'POST',
        url:`/api/series/{{series.id}}/${reload ? 'reload' : 'load'}/${mediaServer}`,
        success: response => {
          $.toast({class: 'blue info', title: 'Loaded Title Cards'});
          getStatistics();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Loading Title Cards',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {}
      });
    }

    function deleteSeries() {
      $.ajax({
        type: 'DELETE',
        url: '/api/series/{{series.id}}',
        success: () => {
          window.location.href = '/';
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Deleting Series',
            message: response.responseJSON.detail,
          });
        },
      });
    }
  
    function deleteTitleCards() {
      $.ajax({
        type: 'DELETE',
        url: '/api/cards/series/{{series.id}}',
        success: (response) => { 
          $.toast({
            class: 'blue info',
            title: `Deleted ${response.deleted} Cards`,
          })
        }, error: (response) => {
          $.toast({
            class: 'error',
            title: 'Error Deleting Title Cards',
            message: response.responseJSON.detail,
          });
        }, complete: () => {
          getStatistics();
        },
      });
    }

    function deleteAllEpisodes() {
      $.ajax({
        type: 'DELETE',
        url: '/api/episodes/series/{{series.id}}',
        success: response => {
          $.toast({class: 'blue info', title: `Deleted ${response.length} Episodes`});
          getEpisodeData();
          getFileData();
          getStatistics();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Deleting Episodes',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {}
      });
    }

    function deleteEpisode(id) {
      $.ajax({
        type: 'DELETE',
        url: `/api/episodes/${id}`,
        success: response => {
          $.toast({
            class: 'blue info',
            title: `Deleted Episode`,
          });
          getEpisodeData();
          getFileData();
          getStatistics();
        }, error: response => {
          $.toast({
            class: 'error',
            title: 'Error Deleting Episode',
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {}
      });
    }

    async function navigateSeries(next_or_previous) {
      // Get the associated Series
      const navSeries = await fetch(`/api/series/{{series.id}}/${next_or_previous}`).then(resp => resp.json());

      // No Series to navigate to, disable nav button
      if (navSeries === null) {
        $(`i[data-action="${next_or_previous}-series"]`).toggleClass('disabled', true);
      } else {
        window.location.href = `/series/${navSeries.id}`;
      }
    }
  </script>
</head>

<body onload="initAll()">
  <script>
    // Initialize series specific dropdowns
    async function initalizeSeriesConfig() {
      // Episode data sources
      const sources = await fetch('/api/available/episode-data-sources').then(resp => resp.json());
      const placeholder = '{{series.episode_data_source}}' === 'None' ? 'Global Default' : '{{series.episode_data_source}}';
      $('#episode-data-source').dropdown({
        placeholder: placeholder,
        values: sources.map(({name, selected}) => {
          return {name: name, value: name, selected: name == '{{series.episode_data_source}}'};
        })
      });
      // Special syncing
      initializeNullableBoolean({
        dropdownElement: $('#series-config-form .dropdown[data-value="sync_specials"]'),
        value: '{{series.sync_specials}}',
      });
      // Skip localized images
      initializeNullableBoolean({
        dropdownElement: $('#series-config-form .dropdown[data-value="skip_localized_images"]'),
        value: '{{series.skip_localized_images}}',
      });
      // Template
      const templates = await fetch('/api/templates/all').then(resp => resp.json());
      $('#card-config-form .dropdown[data-value="template_ids"]').dropdown({
        values: getActiveTemplates({{series.template_ids}}, templates),
      });
      // Card types
      loadCardTypes({
        element: '#card-config-form .dropdown[data-value="card-types"]',
        isSelected: (identifier) => identifier === '{{series.card_type}}',
        showExcluded: false,
        // Dropdown args
        dropdownArgs: {
          placeholder: 'Default',
        }
      });
      // Styles
      const allStyles = await fetch('/api/available/styles').then(resp => resp.json());
      $('#card-config-form .dropdown[data-value="watched-style"]').dropdown({
        values: [
          {name: 'Art Variations', type: 'header'},
          ...allStyles.filter(({style_type}) => style_type === 'art').map(({name, value}) => {
            return {name: name, value: value, selected: value === '{{series.watched_style}}'};
          }),
          {name: 'Unique Variations', type: 'header'},
          ...allStyles.filter(({style_type}) => style_type === 'unique').map(({name, value}) => {
            return {name: name, value: value, selected: value === '{{series.watched_style}}'};
          }),
        ],
      });
      // Unwatched style
      $('#card-config-form .dropdown[data-value="unwatched-style"]').dropdown({
        values: [
          {name: 'Art Variations', type: 'header'},
          ...allStyles.filter(({style_type}) => style_type === 'art').map(({name, value}) => {
            return {name: name, value: value, selected: value === '{{series.unwatched_style}}'};
          }),
          {name: 'Unique Variations', type: 'header'},
          ...allStyles.filter(({style_type}) => style_type === 'unique').map(({name, value}) => {
            return {name: name, value: value, selected: value === '{{series.unwatched_style}}'};
          }),
        ]//, placeholder: 'Global Default',
      });
      // Fonts
      const fonts = await fetch('/api/fonts/all').then(resp => resp.json());
      $('#card-config-form .dropdown[data-value="fonts"]').dropdown({
        values: fonts.map(({id, name}) => {
          return {name: name, value: id, selected: `${id}` === '{{series.font_id}}'};
        })
      });
      // Font card case
      $('#card-config-form .dropdown[data-value="font_title_case"]').dropdown({
        values: [
          {name: 'Blank', value: 'blank', selected: '{{series.font_title_case}}' === 'blank'},
          {name: 'Lowercase', value: 'lower', selected: '{{series.font_title_case}}' === 'lower'},
          {name: 'Source', value: 'source', selected: '{{series.font_title_case}}' === 'source'},
          {name: 'Titlecase', value: 'title', selected: '{{series.font_title_case}}' === 'title'},
          {name: 'Uppercase', value: 'upper', selected: '{{series.font_title_case}}' === 'upper'},
        ],
      });
      // Hide season text
      initializeNullableBoolean({
        dropdownElement: $('#card-config-form .dropdown[data-value="hide_season_text"]'),
        value: '{{series.hide_season_text}}',
      });
      // Hide episode text
      initializeNullableBoolean({
        dropdownElement: $('#card-config-form .dropdown[data-value="hide_episode_text"]'),
        value: '{{series.hide_episode_text}}',
      });
      // Translations
      const allTranslations = await fetch('/api/available/translations').then(resp => resp.json());
      {% if series.translations is not none %}
      if ({{series.translations|safe}}.length > 0) { 
        const translationSegment = $('#card-config-form [data-value="translations"]');
        for (const translation of {{series.translations|safe}}) {
          const newTranslation = document.querySelector('#translation-template').content.cloneNode(true);
          translationSegment.append(newTranslation);
          $(`#card-config-form .dropdown[data-value="language_code"]`).last().dropdown({
            values: [
              {name: 'Language', type: 'header'},
              ...allTranslations.map(({language_code, language}) => {
                return {name: language, value: language_code, selected: translation.language_code === language_code};
              })
            ],
          });
          let extraValue = [];
          if (translation.data_key !== 'preferred_title' && translation.data_key !== 'kanji') {
            extraValue.push({name: translation.data_key, value: translation.data_key, selected: true});
          }
          $(`#card-config-form .dropdown[data-value="data_key"]`).last().dropdown({
            allowAdditions: true,
            values: [
              {name: 'Key', type: 'header'},
              {name: 'Preferred title', text: 'the preferred title', value: 'preferred_title', selected: translation.data_key === 'preferred_title'},
              {name: 'Kanji', text: 'kanji', value: 'kanji', selected: translation.data_key === 'kanji'},
              ...extraValue,
            ]
          });
        }
      }
      {% endif %}
      // Add season title on button press
      $('#card-config-form .button[data-value="addTitle"]').on('click', () => {
        const newRange = document.createElement('input');
        newRange.name = 'season_title_ranges'; newRange.type = 'text';
        newRange.setAttribute('data-value', 'season-titles');
        const newTitle = document.createElement('input');
        newTitle.name = 'season_title_values'; newTitle.type = 'text';
        $('#card-config-form .field[data-value="season-title-range"]').append(newRange);
        $('#card-config-form .field[data-value="season-title-value"]').append(newTitle);
      });
      // Add translation on button press
      $(`#card-config-form .button[data-add-field="translation"]`).on('click', () => {
        const newTranslation = document.querySelector('#translation-template').content.cloneNode(true);
        $(`#card-config-form [data-value="translations"]`).append(newTranslation);
        // Language code dropdown
        $(`#card-config-form .dropdown[data-value="language_code"]`).last().dropdown({
          values: [
            {name: 'Language', type: 'header'},
            ...allTranslations.map(({language_code, language}) => {
              return {name: language, value: language_code};
            })
          ],
        });
        // Data key dropdown
        $(`#card-config-form .dropdown[data-value="data_key"]`).last().dropdown({
          allowAdditions: true,
          values: [
            {name: 'Key', type: 'header'},
            {name: 'Preferred title', text: 'the preferred title', value: 'preferred_title'},
            {name: 'Kanji', text: 'kanji', value: 'kanji'},
          ]
        });
      });
      // Add extra on button press
      $('#card-config-form .button[data-add-field="extra"]').on('click', () => {
        const newKey = document.createElement('input');
        newKey.name = 'extra_keys'; newKey.type = 'text';
        const newValue = document.createElement('input');
        newValue.name = 'extra_values'; newValue.type = 'text';
        $('#card-config-form .field[data-value="extra-key"]').append(newKey);
        $('#card-config-form .field[data-value="extra-value"]').append(newValue);
      });
    }

    async function queryTMDbPoster() {
      $.ajax({
        type: 'PUT',
        url: '/api/series/{{series.id}}/poster/query',
        success: response => {
          if (response === null) {
            $.ajax({class: 'error', title: 'TMDb returned no images'});
          } else {
            $('#edit-poster-modal input[name="poster_url"]').val(response);
          }
        }, error: response => {
          $.ajax({class: 'error', title: 'TMDb returned no images'});
        }, complete: () => {},
      });
    }

    function deleteObject(args) {
      const {url, dataObject, label, deleteElements} = args;
      $.ajax({
        type: 'PATCH',
        url: url,
        data: JSON.stringify(dataObject),
        contentType: 'application/json',
        success: response => {
          $.toast({class: 'blue info', title: `Deleted ${label}`});
          $(deleteElements).remove();
        }, error: response => {
          $.toast({
            class: 'error',
            title: `Error Deleting ${label}`,
            message: response.responseJSON.detail,
            displayTime: 0,
          });
        }, complete: () => {}
      });
    }

    function editEpisodeExtras(episode) {
      // Clear existing values
      $('#episode-extras-modal input').remove();
      // Add existing translations
      for (let [data_key, value] of Object.entries(episode.translations)) {
        const newKey = document.createElement('input');
        newKey.name = 'translation_key'; newKey.value = data_key;
        const newValue = document.createElement('input');
        newValue.name = 'translation_value'; newValue.value = value;
        $('#episode-extras-modal .field[data-value="translation-key"]').append(newKey);
        $('#episode-extras-modal .field[data-value="translation-value"]').append(newValue);
      }
      // Assign functions to add/delete translation buttons
      $('#episode-extras-modal .button[data-delete-field="translations"]').on('click', () => {
        deleteObject({
          url: `/api/episodes/${episode.id}`,
          dataObject: {translations: {}},
          label: 'Translations',
          deleteElements: '#episode-extras-modal .field[data-value="translations"] input',
        });
      });
      // Add existing extras
      if (episode.extras !== null) {
        for (let [key, value] of Object.entries(episode.extras)) {
          const newKey = document.createElement('input');
          newKey.name = 'extra_keys'; newKey.value = key;
          const newValue = document.createElement('input');
          newValue.name = 'extra_values'; newValue.value = value;
          $('#episode-extras-modal .field[data-value="extra-key"]').append(newKey);
          $('#episode-extras-modal .field[data-value="extra-value"]').append(newValue);
        }
      }
      // Assign functions to delete extra buttons
      $('#episode-extras-modal .button[data-delete-field="extras"]').off('click').on('click', () => {
        deleteObject({
          url: `/api/episodes/${episode.id}`,
          dataObject: {extra_keys: null, extra_values: null},
          label: 'Extras',
          deleteElements: '#episode-extras-modal .field[data-value="extras"] input',
        });
      });
      // Show modal
      $('#episode-extras-modal').modal('show');
      // Submit episode extras form
      $('#episode-extras-form').off('submit').on('submit', event => {
        event.preventDefault();
        if (!$('#episode-extras-form').form('is valid')) { return; }
        const translationKeys = $('#episode-extras-modal input[name="translation_key"]');
        const translationValues = $('#episode-extras-modal input[name="translation_value"]');
        const data = {
          extra_keys: $('#episode-extras-modal input[name="extra_keys"]').map((ind, element) => element.value).toArray(),
          extra_values: $('#episode-extras-modal input[name="extra_values"]').map((ind, element) => element.value).toArray(),
        };
        if (translationKeys.length) { 
          data.translations = Object.assign(...translationKeys.map((k, i) => ({ [i.value]: translationValues[k].value })));
        }
        $.ajax({
          type: 'PATCH',
          url: `/api/episodes/${episode.id}`,
          data: JSON.stringify(data),
          contentType: 'application/json',
          success: response => {
            $.toast({class: 'blue info', title: 'Updated Episode'});
          }, error: response => {
            $.toast({
              class: 'error',
              title: 'Error Updating Episode',
              message: response.responseJSON.detail,
              displayTime: 0,
            });
          }, complete: () => {}
        });
      });
    }

    async function getFileData() {
      const fileHolder = document.getElementById('files-list');
      const fileTemplate = document.getElementById('file-template');
      if (fileHolder === null || fileTemplate === null) { return; }
      const allFiles = await fetch('/api/sources/series/{{series.id}}').then(resp => resp.json());

      // Some error occured, toast and exit
      if (allFiles.detail !== undefined) {
        $.toast({
          'class': 'error',
          title: 'Error getting Source details',
          message: allFiles.detail,
          displayTime: 0,
        });
        return;
      }

      const files = allFiles.map(source => {
        const file = fileTemplate.content.cloneNode(true);
        // Fill in the card values present on all files
        const cardId = `file-episode${source.episode_id}`;
        file.querySelector('.card').id = cardId;
        file.querySelector('[data-value="index"]').innerHTML = `Season ${source.season_number} Episode ${source.episode_number}`;
        file.querySelector('[data-value="path"]').innerHTML = source.source_file_name;
        // Launch TMDb browse modal when TMDb logo is clicked
        const tmdbLogo = file.querySelector('[data-action="browse-tmdb"]');
        if (tmdbLogo !== null) {
          tmdbLogo.onclick = () => browseTmdbImages(source.episode_id, cardId);
        }
        // Launch upload source modal when upload icon is clicked
        file.querySelector('i[data-action="upload"]').onclick = () => {
          $('#upload-source-form').off('submit').on('submit', event => {
            event.preventDefault();
            $.ajax({
              type: 'POST',
              url: `/api/sources/episode/${source.episode_id}/upload`,
              data: new FormData(event.target),
              cache: false,
              contentType: false,
              processData: false,
              success: response => {
                $.toast({class: 'blue info', title: 'Updated source image'});
                getFileData();
              }, error: response => {
                $.toast({
                  class: 'error',
                  title: 'Error updating source image',
                  message: response.responseJSON.detail,
                });
              }, complete: () => {
                $('#upload-source-form')[0].reset();
              },
            });
          });
          $('#upload-source-modal').modal('show');
        }
        if (source.exists) {
          // Disable search icon
          file.querySelector('i[data-action="search"]').classList.add('disabled');
          // Remove missing label, fill in dimensions and filesize
          file.querySelector('[data-value="missing"]').remove();
          file.querySelector('[data-value="dimension"]').innerHTML = `${source.width}x${source.height}`;
          file.querySelector('[data-value="filesize"]').innerHTML = formatBytes(source.filesize, 1);
        } else {
          // Add download image function to icon click
          file.querySelector('i[data-action="search"]').onclick = () => getEpisodeSourceImage(source.episode_id, cardId);
          // Make the card red, remove unnecessary elements
          file.querySelector('.card').classList.add('red');
          file.querySelector('[data-value="dimension"]').remove();
          file.querySelector('[data-value="filesize"]').remove();
        }

        return file;
      });
      fileHolder.replaceChildren(...files);
      refreshTheme();
    }

    async function getEpisodeData(page=1) {
      // Get the parent table
      let episodeTable = document.getElementById('episode-data-table');
      if (episodeTable === null) { return; }

      // Get row template
      const rowTemplate = document.querySelector('#episode-row');
      if (rowTemplate === null) { return; }

      // Get page of episodes via API
      const episodeData = await fetch(`/api/episodes/{{series.id}}/all?size=100&page=${page}`).then(resp => resp.json());
      if (episodeData === null || episodeData.items.length === 0) { return; }
      const episodes = episodeData.items;

      // Different HTML for each togglable boolean icon
      function getIcon(value, triState=true) {
        const triStateClass = triState ? ' tristate' : '';
        if (value === null) {
          return `<i class="ui gray question${triStateClass} togglable icon"></i>`;
        } else if (value === true) {
          return `<i class="ui green check${triStateClass} togglable icon"></i>`;
        } else {
          return `<i class="ui red times circle outline${triStateClass} togglable icon"></i>`;
        }
      }

      // Create 
      const rows = episodes.map(episode => {
        // Create new row for this episode
        const row = rowTemplate.content.cloneNode(true);
        // Set row ID
        row.querySelector('tr').id = `episode-id${episode.id}`;
        row.querySelector('tr').dataset.episodeId = episode.id;
        // Assign function to onclick of <a> element
        row.querySelector('td[data-column="edit"] a').onclick = () => saveEpisodeConfig(episode.id);
        // Fill in row data
        row.querySelector('td[data-column="season_number"]').innerHTML = episode.season_number;
        row.querySelector('td[data-column="season_number"]').dataset.sortValue = episode.season_number;
        row.querySelector('td[data-column="episode_number"]').innerHTML = episode.episode_number;
        row.querySelector('td[data-column="episode_number"]').dataset.sortValue = episode.episode_number;
        row.querySelector('input[name="absolute_number"]').value = episode.absolute_number;
        row.querySelector('td[data-column="absolute_number"]').dataset.sortValue = episode.absolute_number;
        row.querySelector('input[name="title"]').value = episode.title;
        row.querySelector('td[data-column="title"]').dataset.sortValue = episode.title;
        row.querySelector('td[data-column="match_title"]').innerHTML = getIcon(episode.match_title, true);
        row.querySelector('td[data-column="auto_split_title"]').innerHTML = getIcon(episode.auto_split_title, false);
          // Template ID
          // Font ID
          // Card type
        row.querySelector('td[data-column="hide_season_text"]').innerHTML = getIcon(episode.hide_season_text, true);
        row.querySelector('input[name="season_text"]').value = episode.season_text;
        row.querySelector('td[data-column="hide_episode_text"]').innerHTML = getIcon(episode.hide_episode_text, true);
        row.querySelector('input[name="episode_text"]').value = episode.episode_text;
          // Unwatched style
          // Watched style
        row.querySelector('input[name="font_color"]').value = episode.font_color;
        row.querySelector('input[name="font_size"]').value = episode.font_size;
        row.querySelector('input[name="font_stroke_width"]').value = episode.font_stroke_width;
        row.querySelector('input[name="font_interline_spacing"]').value = episode.font_interline_spacing;
        row.querySelector('input[name="font_vertical_shift"]').value = episode.font_vertical_shift;
        row.querySelector('td[data-column="extras"] a').onclick = () => editEpisodeExtras(episode);
        row.querySelector('input[name="source_file"]').value = episode.source_file;
        row.querySelector('input[name="card_file"]').value = episode.card_file;
        row.querySelector('td[data-column="watched"]').innerHTML = getIcon(episode.watched, false);
        const embyIdInput = row.querySelector('input[name="emby_id"]');
        if (embyIdInput !== null) { embyIdInput.value = episode.emby_id; }
        row.querySelector('input[name="imdb_id"]').value = episode.imdb_id;
        const jellyfinIdInput = row.querySelector('input[name="jellyfin_id"]');
        if (jellyfinIdInput !== null) { jellyfinIdInput.value = episode.jellyfin_id; }
        row.querySelector('input[name="tmdb_id"]').value = episode.tmdb_id;
        row.querySelector('input[name="tvdb_id"]').value = episode.tvdb_id;
        const tvrageIdInput = row.querySelector('input[name="tvrage_id"]')
        if (tvrageIdInput !== null) { tvrageIdInput.value = episode.tvrage_id; }
        row.querySelector('td[data-column="delete"] a').onclick = () => deleteEpisode(episode.id);
        return row;
      });
      episodeTable.replaceChildren(...rows);

      // Get all available elements for initializing dropdowns
      const allCardTypes = await getAllCardTypes(false);
      const allTemplates = await fetch('/api/templates/all').then(resp => resp.json());
      const allFonts = await fetch('/api/fonts/all').then(resp => resp.json());
      const allStyles = await fetch('/api/available/styles').then(resp => resp.json());

      // Initialize dropdowns, assign form submit API request
      episodes.forEach(episode => {
        // Templates
        $(`#episode-id${episode.id} .dropdown[data-value="template_ids"]`).dropdown({
          values: getActiveTemplates(episode.template_ids, allTemplates),
        });
        // Fonts
        $(`#episode-id${episode.id} .dropdown[data-value="font_id"]`).dropdown({
          values: allFonts.map(({id, name}) => {
            return {name: name, value: id, selected: episode.font_id === id};
          })
        });
        // Card type
        loadCardTypes({
          allCardTypes: allCardTypes,
          element: `#episode-id${episode.id} .dropdown[data-value="card_type"]`,
          isSelected: (identifier) => identifier === episode.card_type,
          showExcluded: false,
          // Dropdown args
          dropdownArgs: {}
        });
        // Unwatched style
        $(`#episode-id${episode.id} .dropdown[data-value="unwatched_style"]`).dropdown({
          values: [
            {name: 'Art Variations', type: 'header'},
            ...allStyles.filter(({style_type}) => style_type === 'art').map(({name, value}) => {
              return {name: name, value: value, selected: value === episode.unwatched_style};
            }),
            {name: 'Unique Variations', type: 'header'},
            ...allStyles.filter(({style_type}) => style_type === 'unique').map(({name, value}) => {
              return {name: name, value: value, selected: value === episode.unwatched_style};
            }),
          ],
        });
        // Watched style
        $(`#episode-id${episode.id} .dropdown[data-value="watched_style"]`).dropdown({
          values: [
            {name: 'Art Variations', type: 'header'},
            ...allStyles.filter(({style_type}) => style_type === 'art').map(({name, value}) => {
              return {name: name, value: value, selected: value === episode.watched_style};
            }),
            {name: 'Unique Variations', type: 'header'},
            ...allStyles.filter(({style_type}) => style_type === 'unique').map(({name, value}) => {
              return {name: name, value: value, selected: value === episode.watched_style};
            }),
          ],
        });
      });
      $('.sortable.table').tablesort()
      initStyles();

      // Update Episode pagination
      updatePagination({
        paginationElementId: 'pagination',
        navigateFunction: getEpisodeData,
        page: episodeData.page,
        pages: episodeData.pages,
        amountVisible: 5,
      });
    }
  </script>

  <div class="pusher">
    <!-- Static header and sidebar loaded by external script -->
    <div id="page-header"></div>
    <div id="nav-menu"></div>

    <!-- Actual page content -->
    <div id="main-content" class="article">
      <div class="ui stackable grid">
        <!-- Poster and label -->
        <div class="four wide column">
          <div class="ui raised card">
            <!-- Series poster -->
            <div id="poster" class="blurring dimmable image">
              <div class="ui dimmer">
                <div class="content">
                  <div class="center">
                    <div class="ui inverted button">Edit Poster</div>
                  </div>
                </div>
              </div>
              <img id="poster-image" src="{{series.poster_url}}" alt="Poster for {{series.name}}">
            </div>
            <!-- Series info (name, year, etc.) -->
            <div class="content">
              <div class="ui right floated">
                <i data-action="previous-series" class="ui arrow alternate circle left outline link icon"></i>
                <i data-action="next-series" class="ui arrow alternate circle right outline link icon"></i>
              </div>
              <div class="header">{{series.name}}</div>
              <div class="meta">
                <span class="date">{{series.year}}</span>
              </div>
            </div>
            <div id="card-count" class="extra content"><!-- Added asynchronously --></div>
            <div id="monitor-status" class="extra content">
              <a onclick="toggleMonitorStatus();" data-tooltip="Monitored Series are automatically updated via the Scheduler">
                {% if series.monitored %}
                <span class="ui left floated green text">
                  <i class="ui eye outline green icon"></i>
                  Monitored
                {% else %}
                <span class="ui left floated red text">
                  <i class="ui eye slash outline red icon"></i>
                  Unmonitored
                {% endif %}
                </span>
              </a>
            </div>
            <div id="card-progress" class="ui bottom attached progress">
              <div class="green bar"></div>
              <div class="red bar"></div>
            </div>
          </div>
          <!-- Series action bottons -->
          <div id="action-buttons">
            <div class="ui vertical labeled icon fluid buttons">
              <button id="refresh" class="ui labeled icon button" onclick="refreshEpisodeData()" data-tooltip="Look for new, and update any existing Episodes">
                <i class="sync icon"></i>
                Refresh Episode Data
              </button>
              {% if series.translations or series.template_ids %}
              <button id="add-translations" class="ui labeled icon button" onclick="addTranslations()" data-tooltip="Look for any missing Episode translations">
                <i class="language icon"></i>
                Add Translations
              </button>
              {% endif %}
              <button id="download-source-images" class="ui labeled icon button" onclick="getSourceImages()" data-tooltip="Search for and download any missing source images">
                <i class="cloud download alternate icon"></i>
                Download Source Images
              </button>
              <button class="ui labeled icon button" onclick="createTitleCards()" data-tooltip="Create missing or outdated Title Cards">
                <i class="images outline icon"></i>
                Create Title Cards
              </button>
            </div>
            <div class="ui divider"></div>
            <div class="ui vertical labeled icon fluid buttons">
              {% if preferences.use_emby and series.emby_library_name %}
              <button class="ui labeled icon button" onclick="loadCards('Emby');">
                <i class="hdd outline icon"></i>
                Load Cards into Emby
              </button>
              <button class="ui labeled icon button" onclick="loadCards('Emby', true);">
                <i class="hdd outline icon"></i>
                Force Reload Cards into Emby
              </button>
              {% elif (preferences.use_emby and not series.emby_library_name) or (not preferences.use_emby and series.emby_library_name) %}
              <button class="ui disabled labeled icon button">
                <i class="hdd outline icon"></i>
                Reload Emby
              </button>
              {% endif %}
                
              {% if preferences.use_jellyfin and series.jellyfin_library_name %}
              <button class="ui labeled icon button" onclick="loadCards('Jellyfin');">
                <i class="hdd outline icon"></i>
                Load Cards into Jellyfin
              </button>
              <button class="ui labeled icon button" onclick="loadCards('Jellyfin', true);">
                <i class="hdd outline icon"></i>
                Force Reload Cards into Jellyfin
              </button>
              {% elif (preferences.use_jellyfin and not series.jellyfin_library_name) or (not preferences.use_jellyfin and series.jellyfin_library_name) %}
              <button class="ui disabled labeled icon button">
                <i class="hdd outline icon"></i>
                Load Cards into Jellyfin
              </button>
              {% endif %}

              {% if preferences.use_plex and series.plex_library_name %}
              <button class="ui labeled icon button" onclick="loadCards('Plex');">
                <i class="hdd outline icon"></i>
                Load Cards into Plex
              </button>
              <button class="ui labeled icon button" onclick="loadCards('Plex', true);">
                <i class="hdd outline icon"></i>
                Force Reload Cards into Plex
              </button>
              {% elif (preferences.use_plex and not series.plex_library_name) or (not preferences.use_plex and series.plex_library_name) %}
              <button class="ui disabled labeled icon button">
                <i class="hdd outline icon"></i>
                Load Cards into Plex
              </button>
              {% endif %}
            </div>
            <div class="ui divider"></div>
            <div class="ui vertical labeled icon fluid buttons">
              <button class="ui labeled icon negative button" onclick="deleteTitleCards();">
                <i class="images outline icon"></i>
                Delete Title Cards
              </button>
              <button id="delete-series" class="ui labeled icon negative button">
                <i class="trash alternate outline icon"></i>
                Delete Series
              </button>
            </div>
          </div>
          
        </div>

        <!-- Data Tabs -->
        <div class="twelve wide column">
          <div class="ui top attached stackable tabular menu">
            <a class="item active" data-tab="configuration">Configuration</a>
            <a class="item" data-tab="card-config">Card Configuration</a>
            <a class="item" data-tab="blueprints">Blueprints</a>
            <a class="item" data-tab="episode-data">Episode Data</a>
            <a class="item" data-tab="files">Files</a>
            <a class="item" data-tab="database-ids">Database ID's</a>
          </div>
          
          <!-- Configuration tab -->
          <div id="series-tabs" class="ui bottom attached tab segment" data-tab="configuration">
            <form id="series-config-form" class="ui compact form">
              <!-- Episode Data Source -->
              <div class="field">
                <label>Episode Data Source</label>
                <div id="episode-data-source" class="ui compact selection clearable dropdown" data-tooltip="Where to get episode data from" data-position="right center">
                  <input name="episode_data_source" type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text"></div>
                  <div class="menu"><!-- Added asynchronously --></div>
                </div>
              </div>

              <div class="ui right aligned checkbox field" data-tooltip="Require episode titles to exactly match the episode data source" data-position="right center">
                {% if series.match_titles %}
                <input name="match_titles" type="checkbox" checked="">
                {% else %}
                <input name="match_titles" type="checkbox">
                {% endif %}
                <label>Match Titles</label>
              </div>

              <!-- Special Syncing -->
              <div class="ui field">
                <label>Sync Specials</label>
                <div data-value="sync_specials" class="ui compact selection clearable dropdown" data-tooltip="Whether to create cards for episodes of Season 0" data-position="right center">
                  <input name="sync_specials" type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text">Default</div>
                  <div class="menu"><!-- Added asynchronously --></div>
                </div>
              </div>

              <!-- Localized Image Skipping -->
              <div class="field">
                <label>Ignore Localized Images</label>
                <div data-value="skip_localized_images" class="ui compact selection clearable dropdown" data-tooltip="Whether to skip images with langauges (on TMDb)" data-position="right center">
                  <input name="skip_localized_images" type="hidden">
                  <i class="dropdown icon"></i>
                  <div class="default text">Default</div>
                  <div class="menu"><!-- Added asynchronously --></div>
                </div>
              </div>

              <!-- Emby Library -->
              {% if preferences.use_emby or series.emby_library_name %}
              <div class="ui field">
                <label>Emby Library</label>
                <div id="emby-library" class="ui compact selection clearable dropdown">
                  <input name="emby_library_name" id="emby-library-input" type="hidden">
                  <div class="default text">None</div>
                  <i class="dropdown icon"></i>
                  <div class="menu"><!-- Added asynchronously --></div>
                </div>
              </div>
              {% endif %}

              <!-- Jellyfin Library -->            
              {% if preferences.use_jellyfin or series.jellyfin_library_name %}
              <div class="ui field">
                <label>Jellyfin Library</label>
                <div id="jellyfin-library" class="ui compact selection clearable dropdown">
                  <input name="jellyfin_library_name" type="hidden">
                  <div class="default text">None</div>
                  <i class="dropdown icon"></i>
                  <div class="menu"><!-- Added asynchronously --></div>
                </div>
              </div>
              {% endif %}

              <!-- Plex Library -->
              {% if preferences.use_plex or series.plex_library_name %}
              <div class="ui field">
                <label>Plex Library</label>
                <div id="plex-library" class="ui compact selection clearable dropdown" data-tooltip="Library within Plex to load Title Cards into" data-position="right center">
                  <input name="plex_library_name" type="hidden">
                  <div class="default text">None</div>
                  <i class="dropdown icon"></i>
                  <div class="menu"><!-- Added asynchronously --></div>
                </div>
              </div>
              {% endif %}

              <!-- Card Directory -->
              <div class="ui field" data-tooltip="Where to store title cards" data-position="top left">
                <label>Card Directory</label>
                <div class="ui left icon fluid input">
                  {% if series.directory is none %}
                  <input name="directory" type="text" placeholder="{{preferences.card_directory}}{{series.path_safe_name}}">
                  {% else %}
                  <input name="directory" type="text" value="{{series.directory}}">
                  {% endif %}
                  <i class="folder icon"></i>
                </div>
              </div>

              <!-- Filename Format -->
              <div class="ui field" placeholder="Global Default" data-tooltip="Format of the title card file names" data-position="top left">
                <label>Filename Format</label>
                {% if series.card_filename_format is none %}
                <input name="card_filename_format" type="text" placeholder="Default">
                {% else %}
                <input name="card_filename_format" type="text" value="{{series.card_filename_format}}">
                {% endif %}
              </div>

              <!-- Submit changes button -->
              <button id="submit-changes" class="ui animated primary button" type="submit">
                <div class="visible content">Save</div>
                <div class="hidden content">
                  <i class="right arrow icon"></i>
                </div>
              </button>
            </form>
          </div>

          <!-- Card Configuration -->
          <div class="ui bottom attached tab segment active" data-tab="card-config">
            <div class="ui stackable grid">
              <!-- Card config  -->
              <div class="sixteen wide column">
                <div class="ui visible floating info message">
                  <i class="info circle icon"></i>
                  Options are listed in increasing priority
                </div>

                <form id="card-config-form" class="ui compact form">
                  <!-- Template ID -->
                  <div class="field">
                    <label>Templates</label>
                    <div data-value="template_ids" class="ui long compact clearable search selection multiple dropdown">
                      <input name="template_ids" type="hidden">
                      <i class="dropdown icon"></i>
                      <div class="default text">None</div>
                      <div class="menu"><!-- Added asynchrously --></div>
                    </div>
                  </div>

                  <div class="ui divider"></div>

                  <!-- Card type and font -->
                  <div class="ui two fields">
                    <div class="field">
                      <label>Card Type</label>
                      <div data-value="card-types" class="ui long selection clearable search dropdown">
                        <input name="card_type" type="hidden">
                        <i class="dropdown icon"></i>
                        <div class="default text">Default</div>
                        <div class="menu"><!-- Added asynchrously --></div>
                      </div>
                    </div>

                    <div class="field">
                      <label>Font</label>
                      <div data-value="fonts" class="ui very long clearable selection search dropdown" data-tooltip="Font to apply to this series (overrides any Template Font)">
                        <input name="font_id" type="hidden">
                        <i class="dropdown icon"></i>
                        <div class="default text">Default</div>
                        <div class="menu"><!-- Added asynchrously --></div>
                      </div>
                    </div>
                  </div>

                  <!-- Styles -->
                  <div class="ui two fields">
                    <div class="field">
                      <label>Watched Episode Style</label>
                      <div data-value="watched-style" class="ui long selection clearable dropdown">
                        <span class="default text">Default</span>
                        <input name="watched_style" type="hidden">
                        <i class="dropdown icon"></i>
                        <div class="menu"><!-- Added asynchronously --></div>
                      </div>
                    </div>
      
                    <div class="field">
                      <label>Unwatched Episode Style</label>
                      <div data-value="unwatched-style" class="ui long selection clearable dropdown">
                        <span class="default text">Default</span>
                        <input name="unwatched_style" type="hidden">
                        <i class="dropdown icon"></i>
                        <div class="menu"><!-- Added asynchronously --></div>
                      </div>
                    </div>
                  </div>

                  <h4 class="ui horizontal middle aligned divider header">Font Overrides</h4>

                  <!-- Font color and case -->
                  <div class="two fields">
                    <div class="field">
                      <label>Color <a href="https://imagemagick.org/script/color.php#color_names" target="_blank"><i class="external alternate small icon"></i></a></label>
                      {% if series.font_color is none %}
                      <input name="font_color" type="text" placeholder="Default">
                      {% else %}
                      <input name="font_color" type="text" placeholder="Default" value="{{series.font_color}}">
                      {% endif %}
                    </div>
    
                    <div class="field">
                      <label>Text Case</label>
                      <div data-value="font_title_case" class="ui clearable selection dropdown">
                        <input name="font_title_case" type="hidden">
                        <div class="default text">Default</div>
                        <i class="dropdown icon"></i>
                        <div class="menu">
                          <div class="item" value="blank">Blank</div>
                          <div class="item" value="lower">Lowercase</div>
                          <div class="item" value="source">Source</div>
                          <div class="item" value="title">Title</div>
                          <div class="item" value="upper">Uppercase</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Font size, kerning, and stroke width -->
                  <div class="three fields">
                    <div class="field">
                      <label>Size</label>
                      <div class="ui right labeled input">
                        {% if series.font_size is none %}
                        <input name="font_size" type="number" placeholder="Default">
                        {% else %}
                        <input name="font_size" type="number" placeholder="Default" value="{{series.font_size*100}}">
                        {% endif %}
                        <div class="ui basic label">%</div>
                      </div>
                    </div>
                    <div class="field">
                      <label>Kerning</label>
                      <div class="ui right labeled input">
                        {% if series.font_kerning is none %}
                        <input name="font_kerning" type="number" placeholder="Default">
                        {% else %}
                        <input name="font_kerning" type="number" placeholder="Default" value="{{series.font_kerning*100}}">
                        {% endif %}
                        <div class="ui basic label">%</div>
                      </div>
                    </div>
                    <div class="field">
                      <label>Stroke Width</label>
                      <div class="ui right labeled input">
                        {% if series.font_kerning is none %}
                        <input name="font_stroke_width" type="number" placeholder="Default">
                        {% else %}
                        <input name="font_stroke_width" type="number" placeholder="Default" value="{{series.font_stroke_width*100}}">
                        {% endif %}
                        <div class="ui basic label">%</div>
                      </div>
                    </div>
                  </div>

                  <!-- Font interline spacing, vertical shift -->
                  <div class="two fields">
                    <div class="field">
                      <label>Interline Spacing</label>
                      {% if series.font_kerning is none %}
                      <input name="font_interline_spacing" type="number" placeholder="Default">
                      {% else %}
                      <input name="font_interline_spacing" type="number" placeholder="Default" value="{{series.font_interline_spacing}}">
                      {% endif %}
                    </div>
    
                    <div class="field">
                      <label>Vertical Shift</label>
                      {% if series.font_kerning is none %}
                      <input name="font_vertical_shift" type="number" placeholder="Default">
                      {% else %}
                      <input name="font_vertical_shift" type="number" placeholder="Default" value="{{series.font_vertical_shift}}">
                      {% endif %}
                    </div>
                  </div>
    
                  <h4 class="ui horizontal middle aligned divider header">Season and Episode Text</h4>

                  <!-- Hide season text -->
                  <div class="ui field">
                    <label>Hide Season Titles</label>
                    <div data-value="hide_season_text" class="ui compact selection clearable dropdown" data-tooltip="Omit season text" data-position="right center">
                      <input name="hide_season_text" type="hidden">
                      <i class="dropdown icon"></i>
                      <div class="default text">Default</div>
                      <div class="menu"></div>
                    </div>
                  </div>
    
                  <!-- Season titles -->
                  <div data-value="season-titles" class="ui field">
                    <label>
                      Season Titles
                      <i class="ui blue question circle outline icon"></i>
                    </label>
                    <div class="two fields">
                      <div data-value="season-title-range" class="three wide right aligned field">
                        <label>Range</label>
                        {% if series.season_titles is not none %}
                        {% for title_range, _ in series.season_titles.items() %}
                        <input name="season_title_ranges" data-value="season-titles" type="text" value="{{title_range}}">
                        {% endfor %}
                        {% endif %}
                      </div>
                      <div data-value="season-title-value" class="eight wide field">
                        <label>Title</label>
                        {% if series.season_titles is not none %}
                        {% for _, title_value in series.season_titles.items() %}
                        <input name="season_title_values" type="text" type="text" value="{{title_value}}">
                        {% endfor %}
                        {% endif %}
                      </div>
                    </div>
                    <div data-value="addTitle" class="ui circular mini icon add-field button">
                      <i class="plus square outline icon"></i>
                      Add Title
                    </div>
                    <div class="ui circular mini icon add-field red button" onclick="deleteListValues('season_titles')">
                      <i class="trash alternate outline icon"></i>
                      Delete Season Titles
                    </div>
                  </div>

                  <!-- Hide episode text -->
                  <div class="ui field">
                    <label>Hide Episode Text</label>
                    <div data-value="hide_episode_text" class="ui compact selection clearable dropdown" data-tooltip="Whether to hide episode text" data-position="right center">
                      <input name="hide_episode_text" type="hidden">
                      <i class="dropdown icon"></i>
                      <div class="default text">Default</div>
                      <div class="menu">
                        <div class="item">True</div>
                        <div class="item">False</div>
                      </div>
                    </div>
                  </div>
    
                  <!-- Episode text format -->
                  <div class="field">
                    <label>Episode Text Format</label>
                    {% if series.episode_text_format is none %}
                    <input name="episode_text_format" type="text" placeholder="Card Default">
                    {% else %}
                    <input name="episode_text_format" type="text" placeholder="Card Default" value="{{series.episode_text_format}}">
                    {% endif %}
                  </div>

                  <h4 class="ui horizontal middle aligned divider header">Miscellaneous</h4>

                  <!-- Translations -->
                  <div class="ui field">
                    <label>Translations</label>
                    <div data-value="translations" class="ui compact segment">
                      <!-- Added asynchrously -->
                    </div>
                    <div data-add-field="translation" class="ui circular mini icon add-field button">
                      <i class="plus square outline icon"></i>
                      Add Translation
                    </div>
                    <div class="ui circular mini icon add-field red button" onclick="deleteListValues('translations')">
                      <i class="trash alternate outline icon"></i>
                      Delete Translations
                    </div>
                  </div>

                  <!-- Extras -->
                  <div class="ui field">
                    <label>Extras</label>
                    <div class="two fields">
                      <div data-value="extra-key" class="four wide right aligned field">
                        <label>Key</label>
                        {% if series.extras is not none %}
                        {% for extra_key, _ in series.extras.items() %}
                        <input name="extra_keys" type="text" value="{{extra_key}}">
                        {% endfor %}
                        {% endif %}
                      </div>
                      <div data-value="extra-value" class="four wide field">
                        <label>Value</label>
                        {% if series.extras is not none %}
                        {% for _, extra_value in series.extras.items() %}
                        <input name="extra_values" type="text" value="{{extra_value}}">
                        {% endfor %}
                        {% endif %}
                      </div>
                    </div>
                    <div data-add-field="extra" class="ui circular mini icon add-field button">
                      <i class="plus square outline icon"></i>
                      Add Extra
                    </div>
                    <div class="ui circular mini icon add-field red button" onclick="deleteListValues('extras')">
                      <i class="trash alternate outline icon"></i>
                      Delete Extras
                    </div>
                  </div>

                  <!-- Submit changes button -->
                  <button id="submit-changes" class="ui animated primary button" type="submit">
                    <div class="visible content">Save</div>
                    <div class="hidden content">
                      <i class="right arrow icon"></i>
                    </div>
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Blueprints Tab -->
          <div class="ui bottom attached tab segment" data-tab="blueprints">
            <button data-action="search" onclick="queryBlueprints();" class="ui green tertiary button" data-tooltip="Search for any existing Blueprints">
              <i class="search icon"></i>
              Search for Blueprints
            </button>
            <button data-action="export" onclick="exportBlueprint();" class="ui blue tertiary button" data-tooltip="Export a zip file with this Series' Blueprint">
              <i class="file export icon"></i>
              Export Blueprint
            </button>
            <div class="ui floating hidden info icon message">
              <i class="blue notched circle loading icon"></i>
              <div class="content">
                <div class="header">Searching for Blueprints</div>
                <p>This may take a moment.</p>
              </div>
            </div>
            <div class="ui floating hidden warning icon message">
              <i class="exclamation icon"></i>
              <div class="content">
                <div class="header">No Blueprints Available</div>
                <span>There are no Blueprints available on <a href="https://github.com/CollinHeist/TitleCardMaker-Blueprints/" target="_blank">GitHub</a>.</span>
                <span>Feel free to submit your own.</span>
              </div>
            </div>
            <br>
            <div id="blueprint-cards" class="ui two stackable raised cards"><!-- Added asynchrously --></div>
            <br>
          </div>

          <!-- Episode Data Tab -->
          <div class="ui bottom attached tab segment" data-tab="episode-data">
            <!-- Mass table editor buttons -->
            <button id="new-episode" class="ui green tertiary button">
              <i class="plus square outline icon"></i>
              Add New Episode
            </button>
            <button class="ui blue tertiary button" onclick="saveAllEpisodes();">
              <i class="save outline icon"></i>
              Save All Changes
            </button>
            <button class="ui red tertiary button" onclick="deleteAllEpisodes();">
              <i class="trash alternate outline icon"></i>
              Delete All Episodes
            </button>

            <!-- Episode data table -->
            <div class="ui scrolling long container">
              <table class="ui compact striped head stuck sortable table">
                <thead>
                  <tr class="center aligned">
                    <th class="collapsing">Save<br>Changes</th>
                    <th class="collapsing">Season</th>
                    <th class="collapsing">Episode</th>
                    <th class="collapsing">Absolute</th>

                    <th class="left aligned">Title</th>
                    <th class="collapsing">Match<br>Title</th>
                    <th class="collapsing">Auto-Split<br>Title</th>

                    <th class="collapsing">Templates</th>
                    <th class="collapsing">Font</th>
                    <th class="collapsing">Card<br>Type</th>

                    <th class="collapsing">Hide<br>Season Text</th>
                    <th class="collapsing">Season<br>Text</th>

                    <th class="collapsing">Hide<br>Episode Text</th>
                    <th class="collapsing">Episode<br>Text</th>

                    <th class="collapsing">Unwatched<br>Style</th>
                    <th class="collapsing">Watched<br>Style</th>

                    <th class="collapsing">Font<br>Color</th>
                    <th class="collapsing">Font<br>Size (%)</th>
                    <th class="collapsing">Font Stroke<br>Width (%)</th>
                    <th class="collapsing">Font Interline<br>Spacing</th>
                    <th class="collapsing">Font<br>Vertical Shift</th>

                    <th class="collapsing">Extras &<br>Translations</th>

                    <th class="collapsing">Source<br>File</th>
                    <th class="collapsing">Card<br>File</th>
                    <th class="collapsing">Watched</th>
                    {% if preferences.use_emby and series.emby_library_name %}
                    <th class="collapsing">Emby<br>ID</th>
                    {% endif %}
                    <th class="collapsing">IMDb<br>ID</th>
                    {% if preferences.use_jellyfin and series.jellyfin_library_name %}
                    <th class="collapsing">Jellyfin<br>ID</th>
                    {% endif %}
                    <th class="collapsing">TMDb<br>ID</th>
                    <th class="collapsing">TVDb<br>ID</th>
                    {% if series.year < 2017 %}
                    <th class="collapsing">TVRage<br>ID</th>
                    {% endif %}
                    <th class="collapsing">Delete</th>
                  </tr>
                </thead>
                <tbody id="episode-data-table" ><!-- Rows added asynchronously --></tbody>
              </table>
            </div>
            <div id="pagination" class="ui attached pagination menu"><!-- Added asynchrously --></div>

            <!-- Icon descriptions -->
            <div class="ui segment">
              <span class="ui text"><i>Click icons to toggle between states.</i></span><br>
              <span class="ui text">
                <i class="ui gray question icon"></i>
                The value is <span class="ui blue text">not set</span> and will be determined by the Series or Template.
              </span>
              <br>
              <span class="ui text">
                <i class="ui green check icon"></i>
                The value is <span class="ui green text">true</span>, overriding any Series or Template.
              </span>
              <br>
              <span class="ui text">
                <i class="ui red times circle outline icon"></i>
                The value is <span class="ui red text">false</span>, overriding any Series or Template.
              </span>
            </div>
          </div>

          <!-- Files Tab -->
          <div class="ui bottom attached tab segment" data-tab="files">
            <div class="ui segment">
              <span class="ui text">
                Source images are located within <span class="ui blue text">{{series.source_directory}}</span>
              </span>
            </div>
            <div id="files-list" class="ui stackable cards"><!-- Added asyncrously --></div>
          </div>

          <!-- Database ID's Tab -->
          <div class="ui bottom attached tab segment" data-tab="database-ids">
            <form id="series-ids-form" class="ui compact form">
              {% if preferences.use_emby %}
              <div id-type="Emby ID" class="field">
                <label>Emby</label>
                {% if series.emby_id %}
                <input name="emby_id" type="text" placeholder="{{series.emby_id}}" value="{{series.emby_id}}">
                {% else %}
                <input name="emby_id" type="text" placeholder="N/A">
                {% endif %}
              </div>
              {% endif %}

              <div id-type="IMDb" class="field">
                {% if series.imdb_id %}
                <label>IMDb <a href="https://www.imdb.com/title/{{series.imdb_id}}" target="_blank"><i class="external alternate small icon"></i></a></label>
                <input name="imdb_id" type="text" placeholder="{{series.imdb_id}}" value="{{series.imdb_id}}">
                {% else %}
                <label>IMDb</label>
                <input name="imdb_id" type="text" placeholder="None">
                {% endif %}
              </div>

              {% if preferences.use_jellyfin %}
              <div id-type="Jellyfin" class="field">
                <label>Jellyfin</label>
                {% if series.jellyfin_id %}
                <input name="jellyfin_id" type="text" placeholder="{{series.jellyfin_id}}" value="{{series.jellyfin_id}}">
                {% else %}
                <input name="jellyfin_id" type="text" placeholder="None">
                {% endif %}
              </div>
              {% endif %}

              {% if preferences.use_sonarr %}
              <div id-type="Sonarr" class="field">
                <label>Sonarr</label>
                {% if series.sonarr_id %}
                <input name="sonarr_id" type="text" placeholder="{{series.sonarr_id}}" value="{{series.sonarr_id}}">
                {% else %}
                <input name="sonarr_id" type="text" placeholder="None">
                {% endif %}
              </div>
              {% endif %}

              <div id-type="TMDb" class="field">
                {% if series.tmdb_id %}
                <label>TMDb <a href="https://www.themoviedb.org/tv/{{series.tmdb_id}}" target="_blank"><i class="external alternate small icon"></i></a></label>
                <input name="tmdb_id" type="text" placeholder="{{series.tmdb_id}}" value="{{series.tmdb_id}}">
                {% else %}
                <label>TMDb</label>
                <input name="tmdb_id" type="text" placeholder="None">
                {% endif %}
              </div>

              <div id-type="TVDb" class="field">
                {% if series.tvdb_id %}
                <label>TVDb <a href="https://thetvdb.com/search?query={{series.tvdb_id}}" target="_blank"><i class="external alternate small icon"></i></a></label>
                <input name="tvdb_id" type="text" placeholder="{{series.tvdb_id}}" value="{{series.tvdb_id}}">
                {% else %}
                <label>TVDb</label>
                <input name="tvdb_id" type="text" placeholder="None">
                {% endif %}
              </div>

              <div id-type="TVRage" class="field">
                <label>TVRage</label>
                {% if series.tvrage_id %}
                <input name="tvrage_id" type="text" placeholder="{{series.tvrage_id}}" value="{{series.tvrage_id}}">
                {% else %}
                <input name="tvrage_id" type="text" placeholder="None">
                {% endif %}
              </div>

              <button class="ui animated primary button" type="submit" form="series-ids-form">
                <div class="visible content">Save</div>
                <div class="hidden content">
                  <i class="right arrow icon"></i>
                </div>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit poster modal -->
    <div id="edit-poster-modal" class="ui mini modal">
      <i class="close icon"></i>
      <div class="header">Edit Poster</div>
      <div class="content">
        <form id="edit-poster-form" class="ui form">
          <!-- URL -->
          <div class="input field">
            <label>URL</label>
            <div class="ui action input">
              <input name="poster_url"></input>
              <button onclick="queryTMDbPoster();" class="ui blue button">Query TMDb</button>
            </div>
          </div>

          <!-- OR divider between URL/upload -->
          <div class="ui horizontal divider">Or</div>

          <!-- File upload -->
          <div class="file clearable input field">
            <label>Upload File</label>
            <input type="file" name="poster_file">
          </div>
        </form>
      </div>
      <div class="actions">
        <button id="submit-poster-button" class="ui positive button" type="submit" form="edit-poster-form">Update</button>
      </div>
    </div>

    <!-- Delete series Modal -->
    <div id="delete-series-modal" class="ui basic modal">
      <div class="ui icon header">
        <i class="trash icon"></i>
        Delete "{{series.name}}"?
      </div>
      <div class="center aligned content">
        <p>This action cannot be undone.</p>
      </div>
      <div class="center aligned actions">
        <div class="ui green ok basic inverted button">
          <i class="remove icon"></i>
          No
        </div>
        <div class="ui red cancel basic inverted button" onclick="deleteSeries();">
          <i class="trash alternate outline icon"></i>
          Yes
        </div>
        <div class="ui red ok inverted button" onclick="deleteTitleCards(); deleteSeries();">
          <i class="images outline icon"></i>
          Yes, and Delete Cards
        </div>
      </div>
    </div>

    <!-- Add source image modal -->
    <div id="upload-source-modal" class="ui mini modal">
      <i class="close icon"></i>
      <div class="header">Upload Source Image</div>
      <div class="content">
        <form id="upload-source-form" class="ui form">
          <div class="input field">
            <label>URL</label>
            <input name="source_url"></input>
          </div>

          <div class="ui horizontal divider">Or</div>

          <div class="file clearable input field">
            <label>Upload File</label>
            <input type="file" name="source_file">
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="ui positive button" type="submit" form="upload-source-form">Upload</button>
      </div>
    </div>

    <!-- TMDb source browser modal -->
    <div id="browse-tmdb-modal" class="ui scrolling content large uninvertible basic modal">
      <i class="close icon"></i>
      <div class="center aligned header">Browse TMDb Source Images</div>
      <div class="center aligned scrolling image content">
        <div class="ui large images"></div>
      </div>
    </div>

    <!-- Add episode modal -->
    <div id="new-episode-modal" class="ui modal">
      <i class="close icon"></i>
      <div class="header">Add Episode</div>
      <div class="content">
        <form id="new-episode-form" class="ui form">
          <div class="input inline field">
            <label>Season Number</label>
            <div class="ui number input">
              <input type="number" min="0" name="season_number">
            </div>
          </div>

          <div class="input inline field">
            <label>Episode Number</label>
            <div class="ui number input">
              <input type="number" min="1" name="episode_number">
            </div>
          </div>

          <div class="input inline field">
            <label>Absolute Number</label>
            <div class="ui number input">
              <input type="number" min="1" name="absolute_number">
            </div>
          </div>

          <div class="input inline field">
            <label>Title</label>
            <div class="ui text input">
              <textarea name="title" minlength="1" rows="2" wrap="soft"></textarea>
            </div>
          </div>
          <div class="ui error message"></div>
        </form>
      </div>
      <div class="actions">
        <button id="new-episode-button" class="ui positive button" type="submit" form="new-episode-form">Add</button>
      </div>
    </div>

    <!-- Episode extras/translations modal -->
    <div id="episode-extras-modal" class="ui small modal">
      <i class="close icon"></i>
      <div class="header">Episode Translations and Extras</div>
      <div class="content">
        <form id="episode-extras-form" class="ui form">
          <div data-value="translations" class="ui field">
            <label>Translations</label>
            <div class="two fields">
              <div data-value="translation-key" class="right aligned field">
                <label>Key</label>
                <!-- <input name="extra_keys" type="text"> -->
              </div>
              <div data-value="translation-value" class="fluid field">
                <label>Value</label>
                <!-- <input name="extra_values" type="text"> -->
              </div>
            </div>
          </div>
          <div data-delete-field="translations" class="ui circular mini icon add-field red button">
            <i class="trash alternate outline icon"></i>
            Delete Translations
          </div>
          <div class="ui divider"></div>
          <div data-value="extras" class="ui field">
            <label>Extras</label>
            <div class="two fields">
              <div data-value="extra-key" class="right aligned field">
                <label>Key</label>
                <!-- <input name="extra_keys" type="text"> -->
              </div>
              <div data-value="extra-value" class="fluid field">
                <label>Value</label>
                <!-- <input name="extra_values" type="text"> -->
              </div>
            </div>
          </div>
          <div data-add-field="extras" class="ui circular mini icon add-field button">
            <i class="plus square outline icon"></i>
            Add Extra
          </div>
          <div data-delete-field="extras" class="ui circular mini icon add-field red button">
            <i class="trash alternate outline icon"></i>
            Delete Extras
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="ui cancel button">Cancel</button>
        <button form="episode-extras-form" class="ui animated primary button" type="submit">
          <div class="visible content">Save</div>
          <div class="hidden content">
            <i class="right arrow icon"></i>
          </div>
        </button>
      </div>
    </div>

    <!-- Season title helper popup -->
    <div id="season-title-popup" class="ui flowing popup right">
      <div class="ui list content">
        <div class="item">
          A number indicates an entire season - e.g. <span class="ui red text">1</span> for <span class="ui red text">season 1</span>.
        </div>
        <div class="item">
          A season and episode range indicates a portion of a season - e.g. <span class="ui blue text">s1e2-s1e5</span> for <span class="ui blue text">season 1, episodes 2-5</span>.
        </div>
        <div class="item">
          A numerical episode range indicates a range of absolute episode numbers - e.g. <span class="ui green text">5-10</span> for (absolute) <span class="ui green text">episodes 5-10</span>.
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enable all dropdowns, menus, and accordians
    $('.ui.dropdown').dropdown();
    // $('.ui.checkbox').checkbox();
    $('.menu .item').tab()
    $('.ui.accordion').accordion();
    $('.ui.checkbox').checkbox();
    // Enable IOS hover on the series poster
    $('#poster').dimmer({
      on: 'ontouchstart' in document.documentElement ? 'click' : 'hover'
    });

    // Make clearable dropdowns clearable
    $('.ui.clearable.dropdown').dropdown({
      'clearable': true,
      'placeholder': 'None',
    });

    // Show season title helper popup
    $('.field[data-value="season-titles"] label i').popup({
      popup : $('#season-title-popup'),
      position: 'right center',
    });

    // Enable edit poster modal, attach to the edit poster div
    $('#edit-poster-modal')
      .modal('attach events', '#poster', 'show')  // Show modal on add buton press
      .modal('setting', 'transition', 'fade up')  // Fade up modal on reveal
      .modal('setting', 'closable', false)        // Don't allow closing by clicking outside modal
      .modal({
        blurring: true,                           // Blur background when shown
        onHidden: ($element) => {                 // Reset input on close
          $('#edit-poster-form')[0].reset();
        }}
      );

    // Previous/next series button
    $('i[data-action="previous-series"]').on('click', () => navigateSeries('previous'));
    $('i[data-action="next-series"]').on('click', () => navigateSeries('next'));

    // Delete series modal
    $('#delete-series-modal').modal('attach events', '#delete-series');

    // Configure new episode modal
    $('#new-episode-modal')
      .modal('attach events', '#new-episode', 'show') // Show modal on add buton press
      .modal('setting', 'transition', 'fade up')      // Fade up modal on reveal
      .modal('setting', 'closable', false)            // Don't allow closing by clicking outside modal
      .modal({
        onApprove: () => {                            // Don't close if form is invalid
          return $('#new-episode-form').form('is valid');
        }, blurring: true,                            // Blur background when shown
      });

    // On edit poster modal submission, submit API request
    $('#edit-poster-form').on('submit', event => {
      event.preventDefault();
      $('#submit-poster-button').toggleClass('loading', true);
      $.ajax({
        type: 'POST',
        url: '/api/series/{{series.id}}/poster',
        data: new FormData(event.target),
        cache: false,
        contentType: false,
        processData: false,
        success: response => {
          $.toast({class: 'blue info', title: 'Updated poster'});
          // Reload image
          $('#poster-image')[0].src = `${response}?${new Date().getTime()}`;
        }, error: (response) => {
          $.toast({
            class: 'error',
            title: 'Error updating poster',
            message: response.responseJSON.detail,
          });
        }, complete: () => {
          setTimeout(() => $('#submit-poster-button').toggleClass('loading', false), 750);
        },
      });
    });

    // Add card config form validation
    $('#card-config-form').form({
      on: 'blur',
      inline: true,
      fields: {
        font_color: {
          optional: true,
          rules: [{type: 'minLength[1]'}],
        },
        font_size: {
          optional: true,
          rules: [{type: 'number', value: 'minValue[1]'}],
        }, font_kerning: {
          optional: true,
          rules: [{type: 'number'}],
        }, font_stroke_width: {
          optional: true,
          rules: [{type: 'number'}],
        }, font_interline_spacing: {
          optional: true,
          rules: [{type: 'number', value: 'integer'}],
        }, font_vertical_shift: {
          optional: true,
          rules: [{type: 'number', value: 'integer'}],
        },
        season_title_ranges: {
          optional: true,
          rules: [{type: 'regExp', value: /^(\d+-\d+)|^(\d+)|^(s\d+e\d+-s\d+e\d+)|^$/i}]
        }, season_title_values: {
          depends: 'season_title_ranges',
          // rules: [{type: 'minLength[1]'}],
        }, language_code: {
          optional: true,
        }, data_key: {
          optional: true,
          depends: 'language_code',
          rules: [{type: 'regExp', value: /^$|^[a-z]+[^ ]*$/i}],
        }, extra_keys: {
          optional: true,
          rules: [{type: 'regExp', value: /^[a-z]+[^ ]*$/i}],
        }, extra_values: {
          optional: true,
          depends: 'extra_keys',
          rules: [{type: 'minLength[1]'}],
        },
      },
    });

    // Add episode extras form validation
    $('#episode-extras-form').form({
      on: 'blur',
      inline: true,
      fields: {
        translation_key: {
          rules: [{type: 'regExp', value: /^[a-z]+[^ ]*$/i}],
        }, translation_value: {
          rules: [{type: 'minLength[1]'}],
        }, extra_keys: {
          optional: true,
          rules: [{type: 'regExp', value: /^[a-z]+[^ ]*$/i}],
        },
      }
    });
    // Add episode extra button press
    $('#episode-extras-modal .button[data-add-field="extras"]').on('click', () => {
      const newKey = document.createElement('input');
      newKey.name = 'extra_keys'; newKey.type = 'text';
      const newValue = document.createElement('input');
      newValue.name = 'extra_values'; newValue.type = 'text';
      $(`#episode-extras-modal .field[data-value="extra-key"]`).append(newKey);
      $(`#episode-extras-modal .field[data-value="extra-value"]`).append(newValue);
    });

    // Delete season titles/translations/extras on button press
    function deleteListValues(attribute) {
      let data;
      if (attribute === 'season_titles') {
        data = {season_title_ranges: null, season_title_values: null};
      } else if (attribute === 'translations') {
        data = {translations: null};
      } else if (attribute === 'extras') {
        data = {extra_keys: null, extra_values: null};
      } else { data = {}; }
      $.ajax({
        type: 'PATCH',
        url: '/api/series/{{series.id}}',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: (response) => {
          if (attribute === 'season_titles') {
            $('.field[data-value="season-title-range"] input').remove();
            $('.field[data-value="season-title-value"] input').remove();
          } else if (attribute === 'translations') {
            $('.field [data-value="translations"] >*').remove();
          } else if (attribute === 'extras') {
            $('.field[data-value="extra-key"] input').remove();
            $('.field[data-value="extra-value"] input').remove();
          }
          $.toast({
            class: 'blue info',
            title: 'Deleted Values',
          });
        }, error: (response) => {
          $.toast({
            class: 'error',
            title: 'Error Deleting Values',
            detail: response.responseText,
          });
        }
      })
    }

    // Submit the updated series config
    $('#series-config-form, #card-config-form, #series-ids-form').on('submit', event => {
      event.preventDefault();
      if (!$('#series-config-form').form('is valid') || !$('#card-config-form').form('is valid')) { return; }
      $('#submit-changes').toggleClass('loading', true);
      // Prepare form data
      let form = new FormData(event.target);
      let listData = {
        extra_keys: [], extra_values: [],
        season_title_ranges: [], season_title_values: [],
        language_code: [], data_key: [],
      };
      let template_ids = [];
      for (const [key, value] of [...form.entries()]) {
        // Handle Templates
        if (key === 'template_ids' && value != '') {
          template_ids = value.split(',');
        }
        // Add list data fields to listData object
        if (Object.keys(listData).includes(key)) {
          if (value !== '') { listData[key].push(value);  }
        }
        // Handle percentage values
        else if (value != '' && ['font_size', 'font_kerning', 'font_stroke_width'].includes(key)) {
          form.set(key, value/100.0);
        }
      }
      // Add translations
      if (listData.language_code.length > 0) {
        let translations = [];
        listData.language_code.forEach((val, index) => {
          if (val !== '') {
            translations.push({language_code: val, data_key: listData.data_key[index]});
          }
        });
        listData.translations = translations;
      }
      // Remove empty list values, and remove list data keys from form
      for (let [key, value] of [...Object.entries(listData)]) {
        if (value.length === 0) { delete listData[key]; }
        form.delete(key);
      }
      // Add checkbox status as true/false
      $.each($("#series-config-form, #card-config-form, #series-ids-form").find('input[type=checkbox]'), (key, val) => {
        form.append($(val).attr('name'), $(val).is(':checked'));
      });

      // Add Templates if the correct form
      if (event.target.id === 'card-config-form') {
        listData.template_ids = template_ids;
      }

      // Submit API request
      $.ajax({
        type: 'PATCH',
        url: '/api/series/{{series.id}}',
        data: JSON.stringify({...Object.fromEntries(form.entries()), ...listData}),
        contentType: 'application/json',
        success: (response) => {
          $('#submit-changes').toggleClass('loading', false);
          $.toast({
            class: 'blue info',
            title: 'Updated Configuration Values',
          });
        }, error: (response) => {
          $.toast({
            class: 'error',
            title: 'Error Updating Configuration',
            detail: response.responseText,
          });
          setTimeout(() => {
            $('#submit-changes').toggleClass('loading', false);
          }, 2000);
        }
      });
    });

    function initStyles() {
      // Toggle icons on click
      $('.table .togglable.icon').on('click', (event) => {
        // Non-tristate icons toggle check <-> x
        // Tristate icons toggle ? -> check -> x -> [...]
        if (event.target.classList.contains('check')) {
          event.target.classList.remove('green', 'check');
          event.target.classList.add('red', 'times', 'circle', 'outline');
        } else if (event.target.classList.contains('question')) {
          event.target.classList.remove('gray', 'question');
          event.target.classList.add('green', 'check');
        } else {
          event.target.classList.remove('red', 'times', 'circle', 'outline');
          // Tristate x goes to ?, bistate x goes to check
          if (event.target.classList.contains('tristate')) {
            event.target.classList.add('gray', 'question');
          } else {
            event.target.classList.add('green', 'check'); 
          }
        }
      });
      // Update input widths when typing
      $('.table .transparent.input:not(.id) input').on('input', (event) => {
        event.target.style.width = Math.max(`${event.target.value}`.length + 1, 8) + 'ch';
      });

      // Refresh theme for any newly added HTML
      refreshTheme();
    }

    // Create a new episode
    $('#new-episode-form').form({
      on: 'blur',
      fields: {
        season_number: ['empty'],
        episode_number: ['empty'],
        title: ['empty', 'minLength[1]'],
      },
    });
    $('#new-episode-form').on('submit', (event) => {
      // Prevent page reload, do not submit if form is invalid
      event.preventDefault();
      if (!$('#new-episode-form').form('is valid')) { return; }
      // Prep form
      let form = new FormData(event.target);
      for (const [key, value] of [...form.entries()]) {
        if (value === '') { form.delete(key); }
      }
      form.append('series_id', {{series.id}});

      $.ajax({
        type: 'POST',
        url: '/api/episodes/new',
        data: JSON.stringify(Object.fromEntries(form)),
        contentType: 'application/json',
        success: (response) => {
          const {season_number, episode_number} = response;
          $.toast({
            class: 'blue info',
            title: `Created Season ${season_number} Episode ${episode_number}`,
          });
          getEpisodeData();
          getStatistics();
        }, error: (response) => {
          $.toast({
            class: 'error',
            title: 'Error Creating New Episode',
            message: response.responseJSON.detail,
            showDuration: 0,
          });
        }
      });
    });

    // Update list of Episode ID's when the input is changed
    let editedEpisodeIds = [];
    $('#episode-data-table')
      .on('change', 'tr input', (e) => {
        const episodeId = $(e.target).closest('tr').data('episode-id')*1;
        if (!editedEpisodeIds.includes(episodeId*1)) { editedEpisodeIds.push(episodeId*1); }
      })
      .on('click', 'tr .icon', (e) => {
        const episodeId = $(e.target).closest('tr').data('episode-id')*1;
        if (!editedEpisodeIds.includes(episodeId*1)) { editedEpisodeIds.push(episodeId*1); }
      });
  </script>
</body>

</html>